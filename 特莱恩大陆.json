{
    "name": "特莱恩大陆",
    "description": "",
    "personality": "",
    "scenario": "",
    "first_mes": "# 开场白\r\n\r\n---\r\n\r\n*意识逐渐恢复，刺眼的阳光透过眼皮照射进来。*\r\n\r\n*头痛欲裂，全身酸痛，你挣扎着睁开双眼。*\r\n\r\n*映入眼帘的是一片陌生的天空——湛蓝得不真实，云朵仿佛棉花糖般柔软。*\r\n\r\n*你躺在一片草地上，四周是郁郁葱葱的森林。远处，一座中世纪风格的城镇若隐若现。*\r\n\r\n\"你醒了？\"\r\n\r\n*一个年轻女性的声音从旁边传来。你转头望去，看到一位身穿银色盔甲的女骑士正蹲在你身边，神情中带着关切和好奇。*\r\n\r\n\"我是艾琳，王国骑士团的副队长。\"她伸出手想扶你起来，\"巡逻时发现你昏倒在这里。你还好吗？你是哪里人？怎么会穿着这么奇怪的衣服？\"\r\n\r\n*你低头看了看自己——还是穿着穿越前的现代服装。*\r\n\r\n*这是……异世界吗？*\r\n\r\n*还没等你理清思绪，远处突然传来一阵骚动。几名士兵骑马疾驰而来，神色慌张。*\r\n\r\n\"艾琳副队长！边境村庄遭到袭击！是哥布林！至少有三四十只！\"\r\n\r\n*艾琳的表情瞬间凝重起来。她站起身，回头看了你一眼。*\r\n\r\n\"抱歉，我必须去处理这件事。你……\"\r\n\r\n*她犹豫了一下，似乎在做某种判断。*\r\n\r\n\"我感觉你不是普通人。如果你愿意帮忙的话……村民们需要我们。\"\r\n\r\n*她指了指不远处的一队士兵——大约二十名装备着剑盾的士兵正在集结。*\r\n\r\n\"这些是临时召集的民兵，缺少一个指挥官。如果你能带领他们……\"\r\n\r\n---\r\n\r\n**你的冒险，从这里开始。**\r\n\r\n*是选择跟随艾琳前往救援，还是另有打算？*\r\n\r\n---\r\n\r\n**【系统提示】**\r\n\r\n你现在拥有：\r\n- 20名剑士部队\r\n- 100金币\r\n- 10份补给\r\n\r\n可用操作：\r\n- 与艾琳对话了解更多情报\r\n- 检查部队状态\r\n- 前往边境村庄\r\n",
    "mes_example": "",
    "creatorcomment": "",
    "avatar": "none",
    "talkativeness": "0.5",
    "fav": false,
    "tags": [],
    "spec": "chara_card_v3",
    "spec_version": "3.0",
    "data": {
        "name": "特莱恩大陆",
        "description": "",
        "personality": "",
        "scenario": "",
        "first_mes": "# 开场白\r\n\r\n---\r\n\r\n*意识逐渐恢复，刺眼的阳光透过眼皮照射进来。*\r\n\r\n*头痛欲裂，全身酸痛，你挣扎着睁开双眼。*\r\n\r\n*映入眼帘的是一片陌生的天空——湛蓝得不真实，云朵仿佛棉花糖般柔软。*\r\n\r\n*你躺在一片草地上，四周是郁郁葱葱的森林。远处，一座中世纪风格的城镇若隐若现。*\r\n\r\n\"你醒了？\"\r\n\r\n*一个年轻女性的声音从旁边传来。你转头望去，看到一位身穿银色盔甲的女骑士正蹲在你身边，神情中带着关切和好奇。*\r\n\r\n\"我是艾琳，王国骑士团的副队长。\"她伸出手想扶你起来，\"巡逻时发现你昏倒在这里。你还好吗？你是哪里人？怎么会穿着这么奇怪的衣服？\"\r\n\r\n*你低头看了看自己——还是穿着穿越前的现代服装。*\r\n\r\n*这是……异世界吗？*\r\n\r\n*还没等你理清思绪，远处突然传来一阵骚动。几名士兵骑马疾驰而来，神色慌张。*\r\n\r\n\"艾琳副队长！边境村庄遭到袭击！是哥布林！至少有三四十只！\"\r\n\r\n*艾琳的表情瞬间凝重起来。她站起身，回头看了你一眼。*\r\n\r\n\"抱歉，我必须去处理这件事。你……\"\r\n\r\n*她犹豫了一下，似乎在做某种判断。*\r\n\r\n\"我感觉你不是普通人。如果你愿意帮忙的话……村民们需要我们。\"\r\n\r\n*她指了指不远处的一队士兵——大约二十名装备着剑盾的士兵正在集结。*\r\n\r\n\"这些是临时召集的民兵，缺少一个指挥官。如果你能带领他们……\"\r\n\r\n---\r\n\r\n**你的冒险，从这里开始。**\r\n\r\n*是选择跟随艾琳前往救援，还是另有打算？*\r\n\r\n---\r\n\r\n**【系统提示】**\r\n\r\n你现在拥有：\r\n- 20名剑士部队\r\n- 100金币\r\n- 10份补给\r\n\r\n可用操作：\r\n- 与艾琳对话了解更多情报\r\n- 检查部队状态\r\n- 前往边境村庄\r\n",
        "mes_example": "",
        "creator_notes": "",
        "system_prompt": "<system_prompt>\r\n# 特莱恩大陆 - AI扮演指南\r\n\r\n你是一个互动式奇幻RPG的游戏大师，负责在特莱恩大陆这个世界中引导玩家的冒险。\r\n\r\n## 你的职责\r\n\r\n### 1. 叙事\r\n- 用生动的文字描述场景、角色和事件\r\n- 扮演NPC与玩家互动\r\n- 根据玩家选择推动剧情发展\r\n- 保持日式西幻风格（类似无职转生、Re:Zero、灰与幻想的格林姆加尔）\r\n\r\n### 2. 战斗设定\r\n当剧情发展到需要战斗时：\r\n1. 根据当前剧情设计合理的敌人配置\r\n2. 使用[战斗配置]格式设定敌方将领和部队\r\n3. 设定胜利条件和特殊规则\r\n4. 根据参战角色的关系设计预设对话\r\n5. 输出[开始战斗]触发战斗系统\r\n\r\n### 3. 战后处理\r\n战斗结束后，你会收到格式化的战斗结果。请根据结果：\r\n- 描述战斗的后续影响\r\n- 处理战后剧情（胜利后的庆祝、失败后的撤退等）\r\n- 更新相关变量（如果需要）\r\n\r\n## 敌人设计指南\r\n\r\n### 可用敌方兵种\r\n| 兵种 | 特点 |\r\n|------|------|\r\n| 哥布林 | 弱小但数量多，适合初期遭遇 |\r\n| 哥布林弓手 | 远程攻击，会使用毒箭 |\r\n| 座狼 | 高速单位，适合突袭场景 |\r\n| 兽人 | 高攻高血，中期强敌 |\r\n| 骷髅兵 | 免疫毒素，亡灵类敌人 |\r\n| 暗影刺客 | 高伤害，后期精英敌人 |\r\n\r\n### 可用敌方将领\r\n| 将领 | 擅长 | 适用场景 |\r\n|------|------|----------|\r\n| 哥布林头目 | 数量战术 | 初期哥布林遭遇 |\r\n| 狼骑士 | 快速突击 | 追击、伏击 |\r\n| 兽人队长 | 正面强攻 | 中期boss战 |\r\n| 亡灵法师 | 魔法攻击 | 地下城、墓地 |\r\n| 暗影领主 | 战术指挥 | 后期boss战 |\r\n\r\n### 预设对话设计\r\n对话应该：\r\n- 符合角色性格和关系\r\n- 增加战斗的戏剧性\r\n- 在适当的时机触发\r\n\r\n支持的触发条件：\r\n- `战斗开始` - 战斗弹窗打开时\r\n- `{A} 攻击 {B}` - 将领A选择攻击将领B时\r\n- `{A} 击败 {B}` - 将领A消灭将领B的部队时\r\n- `我方HP低于{X}%` - 我方总HP低于阈值\r\n- `敌方HP低于{X}%` - 敌方总HP低于阈值\r\n- `回合{N}` - 到达指定回合\r\n- `胜利` / `失败` - 战斗结束时\r\n\r\n## 变量管理\r\n\r\n### 何时更新变量\r\n- 获得或消耗资源时\r\n- 招募新将领时\r\n- 章节推进时\r\n- 其他重要状态变化时\r\n\r\n### 更新格式\r\n```\r\n[变量更新]\r\n{变量路径}: {新值}\r\n[/变量更新]\r\n```\r\n\r\n## 重要注意事项\r\n\r\n1. **战斗是独立系统** - 你只需设定敌人和条件，战斗过程由玩家操作\r\n2. **战斗结果是确定的** - 根据收到的战斗结果继续叙事，不要质疑或改变结果\r\n3. **保持数值合理** - 敌人难度应该循序渐进\r\n4. **预设对话不是必须的** - 只在有意义的时候添加\r\n5. **尊重玩家选择** - 玩家的决策应该有实际影响\r\n\r\n## 示例：战斗配置\r\n\r\n```\r\n[战斗配置]\r\n敌方:\r\n  - 将领: 哥布林头目\r\n    部队: 哥布林\r\n    数量: 25\r\n  - 将领: 哥布林射手\r\n    部队: 哥布林弓手\r\n    数量: 10\r\n\r\n胜利条件: 击败所有敌人\r\n特殊规则: 无\r\n\r\n预设对话:\r\n  - 触发: 战斗开始\r\n    说话者: 哥布林头目\r\n    对话: \"嘎嘎嘎！又有人类送上门来了！兄弟们，上！\"\r\n\r\n  - 触发: 敌方HP低于30%\r\n    说话者: 哥布林头目\r\n    对话: \"可恶...撤退！快撤退！\"\r\n[/战斗配置]\r\n[开始战斗]\r\n```\r\n</system_prompt>\r\n",
        "post_history_instructions": "",
        "tags": [],
        "creator": "TianyiZhuge",
        "character_version": "1.0",
        "alternate_greetings": [],
        "extensions": {
            "talkativeness": "0.5",
            "fav": false,
            "world": "特莱恩大陆",
            "depth_prompt": {
                "prompt": "",
                "depth": 4,
                "role": "system"
            },
            "regex_scripts": [
                {
                    "id": "9698c545-91a1-42c1-a4d5-486057de5d7a",
                    "scriptName": "对AI隐藏状态栏",
                    "disabled": false,
                    "runOnEdit": true,
                    "findRegex": "<StatusPlaceHolderImpl/>",
                    "replaceString": "",
                    "trimStrings": [],
                    "placement": [
                        2
                    ],
                    "substituteRegex": 0,
                    "minDepth": null,
                    "maxDepth": null,
                    "markdownOnly": false,
                    "promptOnly": true
                },
                {
                    "id": "fc3d2d10-c7bc-41b8-8eb5-6d36151134c2",
                    "scriptName": "去除更新变量",
                    "disabled": false,
                    "runOnEdit": true,
                    "findRegex": "/<(UpdateVariable|Analysis|JSONPatch)>[\\s\\S]*?</\\1>/gm",
                    "replaceString": "",
                    "trimStrings": [],
                    "placement": [
                        2
                    ],
                    "substituteRegex": 0,
                    "minDepth": null,
                    "maxDepth": null,
                    "markdownOnly": true,
                    "promptOnly": true
                },
                {
                    "id": "0a826eea-6150-4ef8-b31b-0f10f6f12053",
                    "scriptName": "状态栏",
                    "findRegex": "<StatusPlaceHolderImpl/>",
                    "replaceString": "```\n<!--\r\n  特莱恩大陆 - 战斗系统\r\n  独立JavaScript战斗引擎 + 卡牌式UI\r\n-->\r\n\r\n<style>\r\n/* ========== 基础样式 ========== */\r\n.battle-container {\r\n  display: none;\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: rgba(0, 0, 0, 0.85);\r\n  z-index: 10000;\r\n  font-family: 'Segoe UI', Arial, sans-serif;\r\n}\r\n\r\n.battle-container.active {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.battle-panel {\r\n  width: 90%;\r\n  max-width: 900px;\r\n  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\r\n  border: 2px solid #0f3460;\r\n  border-radius: 12px;\r\n  padding: 20px;\r\n  box-shadow: 0 0 30px rgba(0, 100, 200, 0.3);\r\n}\r\n\r\n/* ========== 战斗区域布局 ========== */\r\n.battle-area {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 15px;\r\n}\r\n\r\n.enemy-section, .ally-section {\r\n  display: flex;\r\n  justify-content: center;\r\n  gap: 15px;\r\n  flex-wrap: wrap;\r\n}\r\n\r\n.battle-log {\r\n  background: rgba(0, 0, 0, 0.5);\r\n  border: 1px solid #0f3460;\r\n  border-radius: 8px;\r\n  padding: 10px;\r\n  height: 120px;\r\n  overflow-y: auto;\r\n  font-size: 13px;\r\n  color: #e0e0e0;\r\n}\r\n\r\n.battle-log .log-entry {\r\n  margin: 3px 0;\r\n  padding: 2px 5px;\r\n}\r\n\r\n.battle-log .log-damage { color: #ff6b6b; }\r\n.battle-log .log-heal { color: #51cf66; }\r\n.battle-log .log-info { color: #74c0fc; }\r\n.battle-log .log-turn { color: #ffd43b; font-weight: bold; }\r\n\r\n/* ========== 卡牌样式 ========== */\r\n.unit-card {\r\n  width: 130px;\r\n  background: linear-gradient(180deg, #2d3436 0%, #1e272e 100%);\r\n  border: 3px solid #8B7355;\r\n  border-radius: 8px;\r\n  padding: 8px;\r\n  text-align: center;\r\n  transition: all 0.3s ease;\r\n  cursor: pointer;\r\n}\r\n\r\n.unit-card.elite {\r\n  border-color: #4169E1;\r\n  box-shadow: 0 0 10px rgba(65, 105, 225, 0.4);\r\n}\r\n\r\n.unit-card.legendary {\r\n  border-color: #FFD700;\r\n  box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);\r\n}\r\n\r\n.unit-card.active {\r\n  border-color: #00ff88;\r\n  box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);\r\n  transform: scale(1.05);\r\n}\r\n\r\n.unit-card.selected {\r\n  border-color: #ff4444;\r\n  box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);\r\n}\r\n\r\n.unit-card.defeated {\r\n  opacity: 0.4;\r\n  filter: grayscale(100%);\r\n  pointer-events: none;\r\n}\r\n\r\n.unit-card .card-portrait {\r\n  width: 80px;\r\n  height: 80px;\r\n  margin: 0 auto 8px;\r\n  border-radius: 4px;\r\n  background-size: cover;\r\n  background-position: center;\r\n  background-color: #444;\r\n}\r\n\r\n.unit-card .card-name {\r\n  font-size: 12px;\r\n  font-weight: bold;\r\n  color: #fff;\r\n  margin-bottom: 4px;\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n}\r\n\r\n.unit-card .card-unit {\r\n  font-size: 11px;\r\n  color: #aaa;\r\n  margin-bottom: 6px;\r\n}\r\n\r\n.unit-card .card-hp-bar {\r\n  height: 8px;\r\n  background: #333;\r\n  border-radius: 4px;\r\n  overflow: hidden;\r\n}\r\n\r\n.unit-card .card-hp-fill {\r\n  height: 100%;\r\n  background: linear-gradient(90deg, #51cf66, #94d82d);\r\n  transition: width 0.3s ease;\r\n}\r\n\r\n.unit-card .card-hp-fill.low {\r\n  background: linear-gradient(90deg, #ff6b6b, #ffa502);\r\n}\r\n\r\n.unit-card .card-hp-fill.critical {\r\n  background: linear-gradient(90deg, #ff4444, #ff6b6b);\r\n}\r\n\r\n/* ========== 对话气泡 ========== */\r\n.dialogue-bubble {\r\n  position: absolute;\r\n  bottom: 100%;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  background: rgba(255, 255, 255, 0.95);\r\n  color: #333;\r\n  padding: 10px 15px;\r\n  border-radius: 10px;\r\n  font-size: 12px;\r\n  max-width: 200px;\r\n  box-shadow: 0 3px 10px rgba(0,0,0,0.3);\r\n  z-index: 100;\r\n  animation: fadeInUp 0.3s ease;\r\n}\r\n\r\n.dialogue-bubble::after {\r\n  content: '';\r\n  position: absolute;\r\n  top: 100%;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  border: 8px solid transparent;\r\n  border-top-color: rgba(255, 255, 255, 0.95);\r\n}\r\n\r\n@keyframes fadeInUp {\r\n  from { opacity: 0; transform: translateX(-50%) translateY(10px); }\r\n  to { opacity: 1; transform: translateX(-50%) translateY(0); }\r\n}\r\n\r\n/* ========== 行动菜单 ========== */\r\n.action-menu {\r\n  display: flex;\r\n  justify-content: center;\r\n  gap: 10px;\r\n  margin-top: 15px;\r\n  flex-wrap: wrap;\r\n}\r\n\r\n.action-btn {\r\n  padding: 10px 20px;\r\n  background: linear-gradient(180deg, #3498db, #2980b9);\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: white;\r\n  font-size: 14px;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.action-btn:hover {\r\n  background: linear-gradient(180deg, #5dade2, #3498db);\r\n  transform: translateY(-2px);\r\n}\r\n\r\n.action-btn:disabled {\r\n  background: #555;\r\n  cursor: not-allowed;\r\n  transform: none;\r\n}\r\n\r\n.action-btn.attack { background: linear-gradient(180deg, #e74c3c, #c0392b); }\r\n.action-btn.attack:hover { background: linear-gradient(180deg, #ec7063, #e74c3c); }\r\n\r\n.action-btn.defend { background: linear-gradient(180deg, #27ae60, #1e8449); }\r\n.action-btn.defend:hover { background: linear-gradient(180deg, #2ecc71, #27ae60); }\r\n\r\n.action-btn.retreat { background: linear-gradient(180deg, #7f8c8d, #6c7a7d); }\r\n.action-btn.retreat:hover { background: linear-gradient(180deg, #95a5a6, #7f8c8d); }\r\n\r\n/* ========== 目标选择提示 ========== */\r\n.target-hint {\r\n  text-align: center;\r\n  color: #ffd43b;\r\n  font-size: 14px;\r\n  margin: 10px 0;\r\n  display: none;\r\n}\r\n\r\n.target-hint.active {\r\n  display: block;\r\n}\r\n\r\n/* ========== 战斗结果界面 ========== */\r\n.battle-result {\r\n  display: none;\r\n  text-align: center;\r\n  padding: 30px;\r\n}\r\n\r\n.battle-result.active {\r\n  display: block;\r\n}\r\n\r\n.battle-result h2 {\r\n  font-size: 28px;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.battle-result.victory h2 { color: #51cf66; }\r\n.battle-result.defeat h2 { color: #ff6b6b; }\r\n.battle-result.retreat h2 { color: #ffd43b; }\r\n\r\n.battle-result .rewards {\r\n  background: rgba(0, 0, 0, 0.3);\r\n  border-radius: 8px;\r\n  padding: 15px;\r\n  margin: 15px 0;\r\n}\r\n\r\n.battle-result .end-btn {\r\n  padding: 12px 30px;\r\n  font-size: 16px;\r\n  background: linear-gradient(180deg, #9b59b6, #8e44ad);\r\n  border: none;\r\n  border-radius: 8px;\r\n  color: white;\r\n  cursor: pointer;\r\n  margin-top: 15px;\r\n}\r\n\r\n.battle-result .end-btn:hover {\r\n  background: linear-gradient(180deg, #a569bd, #9b59b6);\r\n}\r\n\r\n/* ========== 补兵界面 ========== */\r\n.recruit-overlay {\r\n  display: none;\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: rgba(0, 0, 0, 0.8);\r\n  z-index: 10001;\r\n  justify-content: center;\r\n  align-items: center;\r\n}\r\n\r\n.recruit-panel {\r\n  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\r\n  border: 2px solid #0f3460;\r\n  border-radius: 12px;\r\n  padding: 25px;\r\n  min-width: 400px;\r\n  max-width: 500px;\r\n  color: #e0e0e0;\r\n}\r\n\r\n.recruit-panel h2 {\r\n  text-align: center;\r\n  color: #ffd43b;\r\n  margin-bottom: 15px;\r\n}\r\n\r\n.recruit-list {\r\n  margin: 15px 0;\r\n}\r\n\r\n.recruit-item {\r\n  background: rgba(0, 0, 0, 0.3);\r\n  border-radius: 8px;\r\n  padding: 12px;\r\n  margin-bottom: 10px;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n}\r\n\r\n.recruit-info {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 3px;\r\n}\r\n\r\n.recruit-info strong {\r\n  color: #74c0fc;\r\n}\r\n\r\n.recruit-info span {\r\n  font-size: 12px;\r\n  color: #888;\r\n}\r\n\r\n.recruit-actions {\r\n  display: flex;\r\n  gap: 8px;\r\n  align-items: center;\r\n}\r\n\r\n.recruit-actions input {\r\n  width: 60px;\r\n  padding: 5px;\r\n  border: 1px solid #0f3460;\r\n  border-radius: 4px;\r\n  background: #1a1a2e;\r\n  color: white;\r\n  text-align: center;\r\n}\r\n\r\n.recruit-actions button {\r\n  padding: 6px 15px;\r\n  background: linear-gradient(180deg, #27ae60, #1e8449);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: white;\r\n  cursor: pointer;\r\n}\r\n\r\n.recruit-actions button:hover {\r\n  background: linear-gradient(180deg, #2ecc71, #27ae60);\r\n}\r\n\r\n.recruit-panel > button {\r\n  width: 100%;\r\n  padding: 10px;\r\n  margin-top: 10px;\r\n  background: linear-gradient(180deg, #7f8c8d, #6c7a7d);\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: white;\r\n  cursor: pointer;\r\n  font-size: 14px;\r\n}\r\n\r\n.recruit-panel > button:hover {\r\n  background: linear-gradient(180deg, #95a5a6, #7f8c8d);\r\n}\r\n\r\n/* ========== 状态栏入口按钮 ========== */\r\n.battle-status-bar {\r\n  padding: 10px;\r\n  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\r\n  border-radius: 8px;\r\n  margin: 10px 0;\r\n}\r\n\r\n.army-info {\r\n  display: flex;\r\n  gap: 15px;\r\n  flex-wrap: wrap;\r\n  margin-bottom: 10px;\r\n}\r\n\r\n.commander-mini {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  background: rgba(0,0,0,0.3);\r\n  padding: 5px 10px;\r\n  border-radius: 6px;\r\n}\r\n\r\n.commander-mini .mini-portrait {\r\n  width: 30px;\r\n  height: 30px;\r\n  border-radius: 4px;\r\n  background-size: cover;\r\n  background-color: #444;\r\n}\r\n\r\n.commander-mini .mini-info {\r\n  font-size: 12px;\r\n  color: #ddd;\r\n}\r\n\r\n.status-buttons {\r\n  display: flex;\r\n  gap: 10px;\r\n}\r\n\r\n.status-btn {\r\n  padding: 8px 15px;\r\n  background: #3498db;\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: white;\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n}\r\n\r\n.status-btn:hover {\r\n  background: #5dade2;\r\n}\r\n</style>\r\n\r\n<!-- 战斗弹窗容器 -->\r\n<div id=\"battleContainer\" class=\"battle-container\">\r\n  <div class=\"battle-panel\">\r\n    <!-- 战斗区域 -->\r\n    <div id=\"battleArea\" class=\"battle-area\">\r\n      <div class=\"enemy-section\" id=\"enemySection\"></div>\r\n      <div class=\"battle-log\" id=\"battleLog\"></div>\r\n      <div class=\"ally-section\" id=\"allySection\"></div>\r\n      <div class=\"target-hint\" id=\"targetHint\">选择目标</div>\r\n      <div class=\"action-menu\" id=\"actionMenu\"></div>\r\n    </div>\r\n\r\n    <!-- 战斗结果 -->\r\n    <div id=\"battleResult\" class=\"battle-result\">\r\n      <h2 id=\"resultTitle\"></h2>\r\n      <div id=\"resultDetails\"></div>\r\n      <div class=\"rewards\" id=\"rewardsSection\"></div>\r\n      <button class=\"end-btn\" id=\"endBattleBtn\">结束战斗</button>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<!-- 状态栏显示 -->\r\n<div class=\"battle-status-bar\">\r\n  <div class=\"army-info\" id=\"armyInfo\"></div>\r\n  <div class=\"status-buttons\">\r\n    <button class=\"status-btn\" id=\"recruitBtn\" onclick=\"showRecruitPanel()\">补充兵员</button>\r\n    <button class=\"status-btn\" id=\"editCardBtn\">编辑卡面</button>\r\n  </div>\r\n</div>\r\n\r\n<script type=\"module\">\r\n/* ========== 战斗引擎核心 ========== */\r\n\r\n/* 等待MVU系统初始化 */\r\nawait waitGlobalInitialized('Mvu');\r\n\r\n/* 获取游戏数据（从游戏数据.js内联） */\r\nconst UNIT_TEMPLATES = {\r\n  \"剑士\": { hp: 15, atk: 10, def: 8, spd: 5, skills: [\"盾墙\"] },\r\n  \"长枪兵\": { hp: 12, atk: 12, def: 5, spd: 6, skills: [\"枪阵\"] },\r\n  \"弓箭手\": { hp: 10, atk: 14, def: 3, spd: 7, skills: [\"齐射\"] },\r\n  \"骑兵\": { hp: 18, atk: 12, def: 6, spd: 12, skills: [\"冲锋\"] },\r\n  \"法师\": { hp: 8, atk: 16, def: 2, spd: 4, skills: [\"火球术\"] },\r\n  \"牧师\": { hp: 10, atk: 4, def: 4, spd: 3, skills: [\"治愈之光\"] },\r\n  \"哥布林\": { hp: 8, atk: 6, def: 2, spd: 8, skills: [\"群攻\"] },\r\n  \"哥布林弓手\": { hp: 6, atk: 8, def: 1, spd: 7, skills: [\"毒箭\"] },\r\n  \"座狼\": { hp: 12, atk: 10, def: 4, spd: 14, skills: [\"撕咬\"] },\r\n  \"兽人\": { hp: 20, atk: 14, def: 6, spd: 5, skills: [\"狂暴\"] },\r\n  \"骷髅兵\": { hp: 10, atk: 8, def: 4, spd: 4, skills: [\"不死\"] },\r\n  \"暗影刺客\": { hp: 10, atk: 18, def: 2, spd: 15, skills: [\"暗杀\"] },\r\n};\r\n\r\nconst BATTLE_CONSTANTS = {\r\n  DEFENSE_FACTOR: 100,\r\n  DAMAGE_RANDOM_MIN: 0.9,\r\n  DAMAGE_RANDOM_MAX: 1.1,\r\n  BRAVERY_ATK_BONUS: 0.02,\r\n  BASE_EXP_PER_ENEMY: 10,\r\n  BASE_GOLD_PER_ENEMY: 5,\r\n};\r\n\r\n/* ========== 战斗管理器 ========== */\r\nclass BattleManager {\r\n  constructor() {\r\n    this.allies = [];\r\n    this.enemies = [];\r\n    this.turnOrder = [];\r\n    this.currentTurnIndex = 0;\r\n    this.currentTurn = 1;\r\n    this.isPlayerTurn = false;\r\n    this.selectedAction = null;\r\n    this.dialogues = [];\r\n    this.triggeredDialogues = new Set();\r\n    this.battleLog = [];\r\n    this.isActive = false;\r\n  }\r\n\r\n  /* 初始化战斗 */\r\n  initBattle(allyData, enemyData, dialogues = []) {\r\n    this.allies = allyData.map((a, i) => this.createBattleUnit(a, 'ally', i));\r\n    this.enemies = enemyData.map((e, i) => this.createBattleUnit(e, 'enemy', i));\r\n    this.dialogues = dialogues;\r\n    this.triggeredDialogues.clear();\r\n    this.currentTurn = 1;\r\n    this.currentTurnIndex = 0;\r\n    this.battleLog = [];\r\n    this.isActive = true;\r\n\r\n    this.calculateTurnOrder();\r\n    this.renderBattle();\r\n    this.showBattleUI();\r\n    this.checkDialogueTrigger('战斗开始');\r\n    this.startTurn();\r\n  }\r\n\r\n  /* 创建战斗单位 */\r\n  createBattleUnit(data, side, index) {\r\n    const unitTemplate = UNIT_TEMPLATES[data.unit.type] || {};\r\n    const baseHp = unitTemplate.hp || 10;\r\n    const count = data.unit.currentCount || data.unit.count;\r\n\r\n    return {\r\n      id: data.id || `${side}_${index}`,\r\n      name: data.name,\r\n      side: side,\r\n      unit: {\r\n        type: data.unit.type,\r\n        currentCount: count,\r\n        maxCount: data.unit.maxCount || count,\r\n        initialCount: count,\r\n        hp: baseHp,\r\n        atk: unitTemplate.atk || 10,\r\n        def: unitTemplate.def || 5,\r\n        spd: unitTemplate.spd || 5,\r\n        skills: unitTemplate.skills || [],\r\n        frontRowHp: data.unit.frontRowHp || baseHp,\r\n      },\r\n      commander: {\r\n        bravery: data.attributes?.bravery || 10,\r\n        tactics: data.attributes?.tactics || 10,\r\n        leadership: data.attributes?.leadership || 10,\r\n        skills: data.skills || [],\r\n      },\r\n      cardCustomization: data.cardCustomization || {},\r\n      buffs: [],\r\n      isDefending: false,\r\n      isDefeated: false,\r\n    };\r\n  }\r\n\r\n  /* 计算行动顺序（按速度降序） */\r\n  calculateTurnOrder() {\r\n    const allUnits = [...this.allies, ...this.enemies].filter(u => !u.isDefeated);\r\n    this.turnOrder = allUnits.sort((a, b) => {\r\n      const spdA = a.unit.spd + (a.commander.tactics * 0.1);\r\n      const spdB = b.unit.spd + (b.commander.tactics * 0.1);\r\n      return spdB - spdA;\r\n    });\r\n  }\r\n\r\n  /* 开始回合 */\r\n  startTurn() {\r\n    if (!this.isActive) return;\r\n\r\n    /* 检查胜负 */\r\n    if (this.checkBattleEnd()) return;\r\n\r\n    /* 重新计算行动顺序 */\r\n    this.calculateTurnOrder();\r\n\r\n    if (this.currentTurnIndex >= this.turnOrder.length) {\r\n      this.currentTurnIndex = 0;\r\n      this.currentTurn++;\r\n      this.logMessage(`回合 ${this.currentTurn}`, 'turn');\r\n      this.checkDialogueTrigger(`回合${this.currentTurn}`);\r\n    }\r\n\r\n    const currentUnit = this.turnOrder[this.currentTurnIndex];\r\n    if (!currentUnit || currentUnit.isDefeated) {\r\n      this.currentTurnIndex++;\r\n      this.startTurn();\r\n      return;\r\n    }\r\n\r\n    /* 清除防御状态 */\r\n    currentUnit.isDefending = false;\r\n\r\n    /* 更新UI高亮 */\r\n    this.updateActiveUnit(currentUnit);\r\n\r\n    if (currentUnit.side === 'ally') {\r\n      this.isPlayerTurn = true;\r\n      this.showActionMenu(currentUnit);\r\n    } else {\r\n      this.isPlayerTurn = false;\r\n      this.hideActionMenu();\r\n      setTimeout(() => this.executeEnemyAI(currentUnit), 800);\r\n    }\r\n  }\r\n\r\n  /* 玩家选择攻击 */\r\n  selectAttack() {\r\n    this.selectedAction = 'attack';\r\n    this.showTargetSelection();\r\n  }\r\n\r\n  /* 玩家选择防御 */\r\n  selectDefend() {\r\n    const currentUnit = this.turnOrder[this.currentTurnIndex];\r\n    currentUnit.isDefending = true;\r\n    this.logMessage(`${currentUnit.name} 的 ${currentUnit.unit.type} 进入防御姿态`, 'info');\r\n    this.endTurn();\r\n  }\r\n\r\n  /* 玩家选择撤退 */\r\n  selectRetreat() {\r\n    this.endBattle('retreat');\r\n  }\r\n\r\n  /* 执行攻击 */\r\n  executeAttack(attacker, target) {\r\n    /* 检查对话触发 */\r\n    this.checkDialogueTrigger(`${attacker.name} 攻击 ${target.name}`);\r\n\r\n    /* 计算伤害 */\r\n    const damage = this.calculateDamage(attacker, target);\r\n\r\n    /* 应用伤害并计算伤亡 */\r\n    const casualties = this.applyDamage(target, damage);\r\n\r\n    this.logMessage(\r\n      `${attacker.name}【${attacker.unit.type}×${attacker.unit.currentCount}】攻击 ${target.name}【${target.unit.type}】，` +\r\n      `造成 ${Math.round(damage)} 伤害，击杀 ${casualties} 人`,\r\n      'damage'\r\n    );\r\n\r\n    /* 检查是否击败 */\r\n    if (target.isDefeated) {\r\n      this.checkDialogueTrigger(`${attacker.name} 击败 ${target.name}`);\r\n      this.logMessage(`${target.name} 的部队被消灭！`, 'info');\r\n    }\r\n\r\n    this.updateCardUI(target);\r\n    this.hideTargetSelection();\r\n    this.endTurn();\r\n  }\r\n\r\n  /* 计算伤害 */\r\n  calculateDamage(attacker, target) {\r\n    const unitAtk = attacker.unit.atk;\r\n    const count = attacker.unit.currentCount;\r\n    const braveryBonus = 1 + (attacker.commander.bravery * BATTLE_CONSTANTS.BRAVERY_ATK_BONUS);\r\n\r\n    const totalAtk = unitAtk * count * braveryBonus;\r\n\r\n    let targetDef = target.unit.def;\r\n    if (target.isDefending) {\r\n      targetDef *= 1.5;\r\n    }\r\n\r\n    const defReduction = 1 - (targetDef / (targetDef + BATTLE_CONSTANTS.DEFENSE_FACTOR));\r\n    const randomFactor = BATTLE_CONSTANTS.DAMAGE_RANDOM_MIN +\r\n      Math.random() * (BATTLE_CONSTANTS.DAMAGE_RANDOM_MAX - BATTLE_CONSTANTS.DAMAGE_RANDOM_MIN);\r\n\r\n    return totalAtk * defReduction * randomFactor;\r\n  }\r\n\r\n  /* 应用伤害（国王恩赐式HP池） */\r\n  applyDamage(target, damage) {\r\n    const unitHp = target.unit.hp;\r\n    const currentCount = target.unit.currentCount;\r\n    const frontRowHp = target.unit.frontRowHp;\r\n\r\n    /* 计算总HP池 */\r\n    const totalHpPool = (currentCount - 1) * unitHp + frontRowHp;\r\n    const newHpPool = totalHpPool - damage;\r\n\r\n    if (newHpPool <= 0) {\r\n      /* 部队全灭 */\r\n      const casualties = currentCount;\r\n      target.unit.currentCount = 0;\r\n      target.unit.frontRowHp = 0;\r\n      target.isDefeated = true;\r\n      return casualties;\r\n    }\r\n\r\n    /* 计算新的兵员数和前排HP */\r\n    const newCount = Math.ceil(newHpPool / unitHp);\r\n    const newFrontRowHp = newHpPool - (newCount - 1) * unitHp;\r\n\r\n    const casualties = currentCount - newCount;\r\n    target.unit.currentCount = newCount;\r\n    target.unit.frontRowHp = newFrontRowHp > 0 ? newFrontRowHp : unitHp;\r\n\r\n    return casualties;\r\n  }\r\n\r\n  /* 敌方AI */\r\n  executeEnemyAI(enemy) {\r\n    const aliveAllies = this.allies.filter(a => !a.isDefeated);\r\n    if (aliveAllies.length === 0) {\r\n      this.checkBattleEnd();\r\n      return;\r\n    }\r\n\r\n    /* 简单AI：攻击HP最低的目标 */\r\n    const target = aliveAllies.reduce((lowest, ally) => {\r\n      const hpA = lowest.unit.currentCount * lowest.unit.hp;\r\n      const hpB = ally.unit.currentCount * ally.unit.hp;\r\n      return hpB < hpA ? ally : lowest;\r\n    });\r\n\r\n    this.executeAttack(enemy, target);\r\n  }\r\n\r\n  /* 结束当前单位回合 */\r\n  endTurn() {\r\n    this.currentTurnIndex++;\r\n    setTimeout(() => this.startTurn(), 500);\r\n  }\r\n\r\n  /* 检查战斗结束 */\r\n  checkBattleEnd() {\r\n    const aliveAllies = this.allies.filter(a => !a.isDefeated);\r\n    const aliveEnemies = this.enemies.filter(e => !e.isDefeated);\r\n\r\n    /* 检查HP阈值对话 */\r\n    const totalAllyHp = aliveAllies.reduce((sum, a) => sum + a.unit.currentCount * a.unit.hp, 0);\r\n    const maxAllyHp = this.allies.reduce((sum, a) => sum + a.unit.initialCount * a.unit.hp, 0);\r\n    const allyHpPercent = (totalAllyHp / maxAllyHp) * 100;\r\n\r\n    if (allyHpPercent < 30) this.checkDialogueTrigger('我方HP低于30%');\r\n    if (allyHpPercent < 50) this.checkDialogueTrigger('我方HP低于50%');\r\n\r\n    if (aliveEnemies.length === 0) {\r\n      this.endBattle('victory');\r\n      return true;\r\n    }\r\n\r\n    if (aliveAllies.length === 0) {\r\n      this.endBattle('defeat');\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /* 结束战斗 */\r\n  endBattle(result) {\r\n    this.isActive = false;\r\n    this.checkDialogueTrigger(result === 'victory' ? '胜利' : result === 'defeat' ? '失败' : '撤退');\r\n\r\n    /* 计算奖励 */\r\n    const rewards = this.calculateRewards(result);\r\n\r\n    /* 记录伤亡 */\r\n    const ourCasualties = {};\r\n    this.allies.forEach(a => {\r\n      ourCasualties[a.name] = {\r\n        unit: a.unit.type,\r\n        initial: a.unit.initialCount,\r\n        remaining: a.unit.currentCount,\r\n        lost: a.unit.initialCount - a.unit.currentCount,\r\n      };\r\n    });\r\n\r\n    const enemyCasualties = {};\r\n    this.enemies.forEach(e => {\r\n      enemyCasualties[e.name] = {\r\n        unit: e.unit.type,\r\n        initial: e.unit.initialCount,\r\n        remaining: e.unit.currentCount,\r\n        lost: e.unit.initialCount - e.unit.currentCount,\r\n      };\r\n    });\r\n\r\n    /* 显示结果界面 */\r\n    this.showResultUI(result, ourCasualties, enemyCasualties, rewards);\r\n  }\r\n\r\n  /* 计算奖励 */\r\n  calculateRewards(result) {\r\n    if (result !== 'victory') {\r\n      return { exp: 0, gold: 0, items: [] };\r\n    }\r\n\r\n    let exp = 0;\r\n    let gold = 0;\r\n    const items = [];\r\n\r\n    this.enemies.forEach(e => {\r\n      const killed = e.unit.initialCount - e.unit.currentCount;\r\n      exp += killed * BATTLE_CONSTANTS.BASE_EXP_PER_ENEMY;\r\n      gold += killed * BATTLE_CONSTANTS.BASE_GOLD_PER_ENEMY;\r\n    });\r\n\r\n    return { exp, gold, items };\r\n  }\r\n\r\n  /* 检查对话触发 */\r\n  checkDialogueTrigger(trigger) {\r\n    const dialogue = this.dialogues.find(d =>\r\n      d.trigger === trigger && !this.triggeredDialogues.has(d.trigger + d.speaker)\r\n    );\r\n\r\n    if (dialogue) {\r\n      this.triggeredDialogues.add(dialogue.trigger + dialogue.speaker);\r\n      this.showDialogue(dialogue);\r\n    }\r\n  }\r\n\r\n  /* 显示对话气泡 */\r\n  showDialogue(dialogue) {\r\n    /* 查找说话者的卡片 */\r\n    const speaker = [...this.allies, ...this.enemies].find(u => u.name === dialogue.speaker);\r\n    if (!speaker) return;\r\n\r\n    const cardElement = document.querySelector(`[data-unit-id=\"${speaker.id}\"]`);\r\n    if (!cardElement) return;\r\n\r\n    /* 创建对话气泡 */\r\n    const bubble = document.createElement('div');\r\n    bubble.className = 'dialogue-bubble';\r\n    bubble.textContent = dialogue.text;\r\n    cardElement.style.position = 'relative';\r\n    cardElement.appendChild(bubble);\r\n\r\n    /* 自动消失 */\r\n    setTimeout(() => {\r\n      bubble.remove();\r\n\r\n      /* 如果有回应 */\r\n      if (dialogue.responder && dialogue.response) {\r\n        setTimeout(() => {\r\n          this.showDialogue({\r\n            speaker: dialogue.responder,\r\n            text: dialogue.response,\r\n          });\r\n        }, 300);\r\n      }\r\n    }, 3000);\r\n  }\r\n\r\n  /* 记录日志 */\r\n  logMessage(message, type = 'info') {\r\n    this.battleLog.push({ message, type });\r\n    const logContainer = document.getElementById('battleLog');\r\n    if (logContainer) {\r\n      const entry = document.createElement('div');\r\n      entry.className = `log-entry log-${type}`;\r\n      entry.textContent = `> ${message}`;\r\n      logContainer.appendChild(entry);\r\n      logContainer.scrollTop = logContainer.scrollHeight;\r\n    }\r\n  }\r\n\r\n  /* ========== UI方法 ========== */\r\n\r\n  showBattleUI() {\r\n    document.getElementById('battleContainer').classList.add('active');\r\n    document.getElementById('battleArea').style.display = 'flex';\r\n    document.getElementById('battleResult').classList.remove('active');\r\n  }\r\n\r\n  hideBattleUI() {\r\n    document.getElementById('battleContainer').classList.remove('active');\r\n  }\r\n\r\n  renderBattle() {\r\n    /* 渲染敌方 */\r\n    const enemySection = document.getElementById('enemySection');\r\n    enemySection.innerHTML = '';\r\n    this.enemies.forEach(e => {\r\n      enemySection.appendChild(this.createCardElement(e));\r\n    });\r\n\r\n    /* 渲染我方 */\r\n    const allySection = document.getElementById('allySection');\r\n    allySection.innerHTML = '';\r\n    this.allies.forEach(a => {\r\n      allySection.appendChild(this.createCardElement(a));\r\n    });\r\n\r\n    /* 清空日志 */\r\n    document.getElementById('battleLog').innerHTML = '';\r\n    this.logMessage(`回合 ${this.currentTurn}`, 'turn');\r\n  }\r\n\r\n  createCardElement(unit) {\r\n    const card = document.createElement('div');\r\n    card.className = `unit-card ${unit.cardCustomization?.frame || 'normal'}`;\r\n    card.dataset.unitId = unit.id;\r\n    card.dataset.side = unit.side;\r\n\r\n    if (unit.isDefeated) {\r\n      card.classList.add('defeated');\r\n    }\r\n\r\n    const hpPercent = (unit.unit.currentCount / unit.unit.maxCount) * 100;\r\n    const hpClass = hpPercent <= 30 ? 'critical' : hpPercent <= 60 ? 'low' : '';\r\n\r\n    const portrait = unit.cardCustomization?.portrait ||\r\n      `https://placehold.co/80x80/4a5568/ffffff?text=${encodeURIComponent(unit.unit.type.charAt(0))}`;\r\n\r\n    card.innerHTML = `\r\n      <div class=\"card-portrait\" style=\"background-image: url('${portrait}')\"></div>\r\n      <div class=\"card-name\">${unit.name}</div>\r\n      <div class=\"card-unit\">[${unit.unit.type}×${unit.unit.currentCount}]</div>\r\n      <div class=\"card-hp-bar\">\r\n        <div class=\"card-hp-fill ${hpClass}\" style=\"width: ${hpPercent}%\"></div>\r\n      </div>\r\n    `;\r\n\r\n    /* 点击选择目标 */\r\n    card.addEventListener('click', () => {\r\n      if (this.isPlayerTurn && this.selectedAction === 'attack' && unit.side === 'enemy' && !unit.isDefeated) {\r\n        this.executeAttack(this.turnOrder[this.currentTurnIndex], unit);\r\n      }\r\n    });\r\n\r\n    return card;\r\n  }\r\n\r\n  updateCardUI(unit) {\r\n    const card = document.querySelector(`[data-unit-id=\"${unit.id}\"]`);\r\n    if (!card) return;\r\n\r\n    if (unit.isDefeated) {\r\n      card.classList.add('defeated');\r\n    }\r\n\r\n    const hpPercent = (unit.unit.currentCount / unit.unit.maxCount) * 100;\r\n    const hpClass = hpPercent <= 30 ? 'critical' : hpPercent <= 60 ? 'low' : '';\r\n\r\n    card.querySelector('.card-unit').textContent = `[${unit.unit.type}×${unit.unit.currentCount}]`;\r\n    const hpFill = card.querySelector('.card-hp-fill');\r\n    hpFill.style.width = `${hpPercent}%`;\r\n    hpFill.className = `card-hp-fill ${hpClass}`;\r\n  }\r\n\r\n  updateActiveUnit(unit) {\r\n    document.querySelectorAll('.unit-card').forEach(c => c.classList.remove('active'));\r\n    const card = document.querySelector(`[data-unit-id=\"${unit.id}\"]`);\r\n    if (card) card.classList.add('active');\r\n  }\r\n\r\n  showActionMenu(unit) {\r\n    const menu = document.getElementById('actionMenu');\r\n    menu.innerHTML = `\r\n      <button class=\"action-btn attack\" onclick=\"window.battleManager.selectAttack()\">攻击</button>\r\n      <button class=\"action-btn defend\" onclick=\"window.battleManager.selectDefend()\">防御</button>\r\n      <button class=\"action-btn retreat\" onclick=\"window.battleManager.selectRetreat()\">撤退</button>\r\n    `;\r\n  }\r\n\r\n  hideActionMenu() {\r\n    document.getElementById('actionMenu').innerHTML = '';\r\n  }\r\n\r\n  showTargetSelection() {\r\n    document.getElementById('targetHint').classList.add('active');\r\n    document.querySelectorAll('.unit-card[data-side=\"enemy\"]:not(.defeated)').forEach(c => {\r\n      c.classList.add('selectable');\r\n    });\r\n  }\r\n\r\n  hideTargetSelection() {\r\n    document.getElementById('targetHint').classList.remove('active');\r\n    document.querySelectorAll('.unit-card').forEach(c => {\r\n      c.classList.remove('selectable', 'selected');\r\n    });\r\n    this.selectedAction = null;\r\n  }\r\n\r\n  showResultUI(result, ourCasualties, enemyCasualties, rewards) {\r\n    document.getElementById('battleArea').style.display = 'none';\r\n    const resultDiv = document.getElementById('battleResult');\r\n    resultDiv.classList.add('active', result);\r\n\r\n    const titles = {\r\n      victory: '战斗胜利！',\r\n      defeat: '战斗失败...',\r\n      retreat: '成功撤退',\r\n    };\r\n    document.getElementById('resultTitle').textContent = titles[result];\r\n\r\n    /* 伤亡详情 */\r\n    let detailsHtml = '<h3>我方伤亡</h3><ul>';\r\n    Object.entries(ourCasualties).forEach(([name, data]) => {\r\n      detailsHtml += `<li>${name} [${data.unit}]: ${data.initial}→${data.remaining} (阵亡${data.lost}人)</li>`;\r\n    });\r\n    detailsHtml += '</ul><h3>敌方伤亡</h3><ul>';\r\n    Object.entries(enemyCasualties).forEach(([name, data]) => {\r\n      const status = data.remaining === 0 ? '全灭' : `剩余${data.remaining}人`;\r\n      detailsHtml += `<li>${name} [${data.unit}]: ${status}</li>`;\r\n    });\r\n    detailsHtml += '</ul>';\r\n    document.getElementById('resultDetails').innerHTML = detailsHtml;\r\n\r\n    /* 奖励 */\r\n    if (result === 'victory') {\r\n      document.getElementById('rewardsSection').innerHTML = `\r\n        <h3>获得奖励</h3>\r\n        <p>经验: ${rewards.exp}</p>\r\n        <p>金币: ${rewards.gold}</p>\r\n      `;\r\n    } else {\r\n      document.getElementById('rewardsSection').innerHTML = '';\r\n    }\r\n\r\n    /* 保存战斗结果供发送 */\r\n    this.battleResult = {\r\n      result,\r\n      turns: this.currentTurn,\r\n      ourCasualties,\r\n      enemyCasualties,\r\n      rewards,\r\n    };\r\n  }\r\n\r\n  /* 生成战斗结果文本（用于发送给LLM） */\r\n  generateResultText() {\r\n    const r = this.battleResult;\r\n    const resultText = r.result === 'victory' ? '胜利' : r.result === 'defeat' ? '失败' : '撤退';\r\n\r\n    let text = `[战斗结果]\\n结果: ${resultText}\\n回合数: ${r.turns}\\n`;\r\n\r\n    text += '我方伤亡:\\n';\r\n    Object.entries(r.ourCasualties).forEach(([name, data]) => {\r\n      text += `  - ${name} [${data.unit}]: ${data.initial}→${data.remaining} (阵亡${data.lost}人)\\n`;\r\n    });\r\n\r\n    text += '敌方伤亡:\\n';\r\n    Object.entries(r.enemyCasualties).forEach(([name, data]) => {\r\n      const status = data.remaining === 0 ? '全灭' : `剩余${data.remaining}人`;\r\n      text += `  - ${name} [${data.unit}]: ${status}\\n`;\r\n    });\r\n\r\n    if (r.result === 'victory') {\r\n      text += '获得奖励:\\n';\r\n      text += `  - 经验: ${r.rewards.exp}\\n`;\r\n      text += `  - 金币: ${r.rewards.gold}\\n`;\r\n    }\r\n\r\n    text += '[/战斗结果]';\r\n    return text;\r\n  }\r\n}\r\n\r\n/* ========== 全局实例 ========== */\r\nwindow.battleManager = new BattleManager();\r\n\r\n/* ========== 战后系统 ========== */\r\n\r\n/* 应用战斗结果到变量 */\r\nfunction applyBattleResults() {\r\n  const bm = window.battleManager;\r\n  if (!bm.battleResult) return;\r\n\r\n  const statData = _.get(window, 'Mvu.statData', {});\r\n  const r = bm.battleResult;\r\n\r\n  /* 更新我方部队伤亡 */\r\n  Object.entries(r.ourCasualties).forEach(([name, data]) => {\r\n    const commander = statData.army?.commanders?.find(c => c.name === name);\r\n    if (commander) {\r\n      commander.unit.currentCount = data.remaining;\r\n    }\r\n  });\r\n\r\n  /* 应用奖励 */\r\n  if (r.result === 'victory' && r.rewards) {\r\n    statData.resources = statData.resources || {};\r\n    statData.resources.gold = (statData.resources.gold || 0) + r.rewards.gold;\r\n\r\n    /* 更新进度 */\r\n    statData.progress = statData.progress || {};\r\n    statData.progress.totalBattles = (statData.progress.totalBattles || 0) + 1;\r\n    statData.progress.victories = (statData.progress.victories || 0) + 1;\r\n  } else {\r\n    /* 战败也计入总战斗次数 */\r\n    statData.progress = statData.progress || {};\r\n    statData.progress.totalBattles = (statData.progress.totalBattles || 0) + 1;\r\n  }\r\n\r\n  /* 触发MVU更新 */\r\n  if (window.Mvu && window.Mvu.updateView) {\r\n    window.Mvu.updateView();\r\n  }\r\n}\r\n\r\n/* 补兵系统 - 计算补兵费用 */\r\nfunction getRecruitCost(unitType) {\r\n  const UNIT_COSTS = {\r\n    '剑士': { gold: 10, supplies: 1 },\r\n    '长枪兵': { gold: 12, supplies: 1 },\r\n    '弓箭手': { gold: 15, supplies: 1 },\r\n    '骑兵': { gold: 25, supplies: 2 },\r\n    '法师': { gold: 30, supplies: 2 },\r\n    '牧师': { gold: 28, supplies: 2 },\r\n  };\r\n  return UNIT_COSTS[unitType] || { gold: 10, supplies: 1 };\r\n}\r\n\r\n/* 补兵系统 - 执行补兵 */\r\nfunction recruitSoldiers(commanderIndex, count) {\r\n  const statData = _.get(window, 'Mvu.statData', {});\r\n  const commander = statData.army?.commanders?.[commanderIndex];\r\n  if (!commander) return { success: false, message: '将领不存在' };\r\n\r\n  const unit = commander.unit;\r\n  const maxRecruit = unit.maxCount - unit.currentCount;\r\n  const actualCount = Math.min(count, maxRecruit);\r\n\r\n  if (actualCount <= 0) return { success: false, message: '部队已满员' };\r\n\r\n  const cost = getRecruitCost(unit.type);\r\n  const totalGold = cost.gold * actualCount;\r\n  const totalSupplies = cost.supplies * actualCount;\r\n\r\n  const resources = statData.resources || {};\r\n  if (resources.gold < totalGold) return { success: false, message: '金币不足' };\r\n  if (resources.supplies < totalSupplies) return { success: false, message: '补给不足' };\r\n\r\n  /* 扣除资源 */\r\n  resources.gold -= totalGold;\r\n  resources.supplies -= totalSupplies;\r\n\r\n  /* 增加兵员 */\r\n  unit.currentCount += actualCount;\r\n  unit.frontRowHp = getUnitHp(unit.type); /* 新兵满HP */\r\n\r\n  /* 触发MVU更新 */\r\n  if (window.Mvu && window.Mvu.updateView) {\r\n    window.Mvu.updateView();\r\n  }\r\n\r\n  return { success: true, message: `成功招募${actualCount}名${unit.type}` };\r\n}\r\n\r\n/* 获取兵种HP */\r\nfunction getUnitHp(unitType) {\r\n  const UNIT_HP = {\r\n    '剑士': 15, '长枪兵': 12, '弓箭手': 10,\r\n    '骑兵': 18, '法师': 8, '牧师': 10,\r\n  };\r\n  return UNIT_HP[unitType] || 10;\r\n}\r\n\r\n/* 显示补兵界面 */\r\nfunction showRecruitPanel() {\r\n  const statData = _.get(window, 'Mvu.statData', {});\r\n  const commanders = statData.army?.commanders || [];\r\n  const resources = statData.resources || {};\r\n\r\n  let html = `\r\n    <div class=\"recruit-panel\">\r\n      <h2>补充兵员</h2>\r\n      <p>金币: ${resources.gold || 0} | 补给: ${resources.supplies || 0}</p>\r\n      <div class=\"recruit-list\">\r\n  `;\r\n\r\n  commanders.forEach((c, index) => {\r\n    const cost = getRecruitCost(c.unit.type);\r\n    const missing = c.unit.maxCount - c.unit.currentCount;\r\n    html += `\r\n      <div class=\"recruit-item\">\r\n        <div class=\"recruit-info\">\r\n          <strong>${c.name}</strong>\r\n          <span>[${c.unit.type}] ${c.unit.currentCount}/${c.unit.maxCount}</span>\r\n          <span>费用: ${cost.gold}金币 + ${cost.supplies}补给/人</span>\r\n        </div>\r\n        <div class=\"recruit-actions\">\r\n          <input type=\"number\" id=\"recruit_${index}\" min=\"0\" max=\"${missing}\" value=\"${Math.min(missing, 5)}\" />\r\n          <button onclick=\"doRecruit(${index})\">补充</button>\r\n        </div>\r\n      </div>\r\n    `;\r\n  });\r\n\r\n  html += `\r\n      </div>\r\n      <button onclick=\"closeRecruitPanel()\">关闭</button>\r\n    </div>\r\n  `;\r\n\r\n  let panel = document.getElementById('recruitPanelContainer');\r\n  if (!panel) {\r\n    panel = document.createElement('div');\r\n    panel.id = 'recruitPanelContainer';\r\n    panel.className = 'recruit-overlay';\r\n    document.body.appendChild(panel);\r\n  }\r\n  panel.innerHTML = html;\r\n  panel.style.display = 'flex';\r\n}\r\n\r\nfunction doRecruit(commanderIndex) {\r\n  const input = document.getElementById(`recruit_${commanderIndex}`);\r\n  const count = parseInt(input.value) || 0;\r\n  const result = recruitSoldiers(commanderIndex, count);\r\n  alert(result.message);\r\n  if (result.success) {\r\n    showRecruitPanel(); /* 刷新界面 */\r\n    updateStatusBar();\r\n  }\r\n}\r\n\r\nfunction closeRecruitPanel() {\r\n  const panel = document.getElementById('recruitPanelContainer');\r\n  if (panel) panel.style.display = 'none';\r\n}\r\n\r\n/* 暴露给全局使用 */\r\nwindow.showRecruitPanel = showRecruitPanel;\r\n\r\n/* ========== 结束战斗按钮处理 ========== */\r\ndocument.getElementById('endBattleBtn').addEventListener('click', () => {\r\n  const resultText = window.battleManager.generateResultText();\r\n\r\n  /* 应用战斗结果到变量 */\r\n  applyBattleResults();\r\n\r\n  /* 发送战斗结果作为用户消息 */\r\n  const sendInput = document.getElementById('send_textarea');\r\n  if (sendInput) {\r\n    sendInput.value = resultText;\r\n    const sendBtn = document.getElementById('send_but');\r\n    if (sendBtn) sendBtn.click();\r\n  }\r\n\r\n  /* 关闭战斗UI */\r\n  window.battleManager.hideBattleUI();\r\n\r\n  /* 更新状态栏 */\r\n  updateStatusBar();\r\n});\r\n\r\n/* ========== 监听战斗触发 ========== */\r\nconst observer = new MutationObserver((mutations) => {\r\n  mutations.forEach((mutation) => {\r\n    mutation.addedNodes.forEach((node) => {\r\n      if (node.nodeType === Node.ELEMENT_NODE) {\r\n        const text = node.textContent || '';\r\n        if (text.includes('[开始战斗]')) {\r\n          /* 解析战斗配置 */\r\n          parseBattleConfig(text);\r\n        }\r\n      }\r\n    });\r\n  });\r\n});\r\n\r\n/* 观察聊天消息区域 */\r\nconst chatContainer = document.getElementById('chat');\r\nif (chatContainer) {\r\n  observer.observe(chatContainer, { childList: true, subtree: true });\r\n}\r\n\r\n/* 解析战斗配置 */\r\nfunction parseBattleConfig(text) {\r\n  const configMatch = text.match(/\\[战斗配置\\]([\\s\\S]*?)\\[\\/战斗配置\\]/);\r\n  if (!configMatch) return;\r\n\r\n  const configText = configMatch[1];\r\n\r\n  /* 简单解析（后续可改用更完善的YAML解析） */\r\n  const enemies = [];\r\n  const dialogues = [];\r\n\r\n  /* 解析敌方 */\r\n  const enemyMatches = configText.matchAll(/将领:\\s*(.+?)\\n\\s*部队:\\s*(.+?),\\s*数量:\\s*(\\d+)/g);\r\n  let enemyIndex = 0;\r\n  for (const match of enemyMatches) {\r\n    enemies.push({\r\n      id: `enemy_${enemyIndex++}`,\r\n      name: match[1].trim(),\r\n      unit: {\r\n        type: match[2].trim(),\r\n        count: parseInt(match[3]),\r\n      },\r\n      skills: [],\r\n    });\r\n  }\r\n\r\n  /* 解析对话 */\r\n  const dialogueSection = configText.match(/预设对话:([\\s\\S]*?)(?=$|\\n\\n)/);\r\n  if (dialogueSection) {\r\n    const dialogueMatches = dialogueSection[1].matchAll(\r\n      /触发:\\s*(.+?)\\n\\s*说话者:\\s*(.+?)\\n\\s*对话:\\s*\"(.+?)\"/g\r\n    );\r\n    for (const match of dialogueMatches) {\r\n      const dialogue = {\r\n        trigger: match[1].trim(),\r\n        speaker: match[2].trim(),\r\n        text: match[3].trim(),\r\n      };\r\n\r\n      /* 检查回应 */\r\n      const responseMatch = configText.match(\r\n        new RegExp(`对话:\\\\s*\"${match[3]}\"\\\\s*\\n\\\\s*回应者:\\\\s*(.+?)\\\\n\\\\s*回应:\\\\s*\"(.+?)\"`)\r\n      );\r\n      if (responseMatch) {\r\n        dialogue.responder = responseMatch[1].trim();\r\n        dialogue.response = responseMatch[2].trim();\r\n      }\r\n\r\n      dialogues.push(dialogue);\r\n    }\r\n  }\r\n\r\n  /* 获取我方军队数据 */\r\n  const statData = _.get(window, 'Mvu.statData', {});\r\n  const allyCommanders = _.get(statData, 'army.commanders', []);\r\n\r\n  if (enemies.length > 0 && allyCommanders.length > 0) {\r\n    window.battleManager.initBattle(allyCommanders, enemies, dialogues);\r\n  }\r\n}\r\n\r\n/* ========== 更新状态栏显示 ========== */\r\nfunction updateStatusBar() {\r\n  const statData = _.get(window, 'Mvu.statData', {});\r\n  const commanders = _.get(statData, 'army.commanders', []);\r\n  const resources = _.get(statData, 'resources', {});\r\n\r\n  const armyInfo = document.getElementById('armyInfo');\r\n  if (armyInfo) {\r\n    armyInfo.innerHTML = commanders.map(c => `\r\n      <div class=\"commander-mini\">\r\n        <div class=\"mini-portrait\" style=\"background-image: url('${c.cardCustomization?.portrait || 'https://placehold.co/30x30/4a5568/ffffff'}')\"></div>\r\n        <div class=\"mini-info\">\r\n          <div>${c.name}</div>\r\n          <div>[${c.unit.type}×${c.unit.currentCount}]</div>\r\n        </div>\r\n      </div>\r\n    `).join('') + `\r\n      <div class=\"commander-mini\">\r\n        <div class=\"mini-info\">\r\n          <div>金币: ${resources.gold || 0}</div>\r\n          <div>补给: ${resources.supplies || 0}</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n}\r\n\r\n/* 初始化状态栏 */\r\nupdateStatusBar();\r\n\r\n/* 定期更新状态栏 */\r\nsetInterval(updateStatusBar, 5000);\r\n</script>\r\n\n```",
                    "trimStrings": [],
                    "placement": [
                        2
                    ],
                    "disabled": false,
                    "markdownOnly": true,
                    "promptOnly": false,
                    "runOnEdit": true,
                    "substituteRegex": 0,
                    "minDepth": null,
                    "maxDepth": 2
                }
            ],
            "TavernHelper_scripts": [
                {
                    "type": "script",
                    "value": {
                        "id": "1f84fa2d-cd60-4015-be1b-cc801a8092be",
                        "name": "MVU Zod 脚本",
                        "content": "import 'https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate/artifact/bundle.js'",
                        "info": "",
                        "buttons": [
                            {
                                "name": "重新处理变量",
                                "visible": false
                            },
                            {
                                "name": "重新读取初始变量",
                                "visible": false
                            },
                            {
                                "name": "清除旧楼层变量",
                                "visible": false
                            }
                        ],
                        "data": {
                            "是否显示变量更新错误": "是",
                            "构建信息": "2026-01-13T03:31:30.050Z (generated)"
                        },
                        "enabled": true
                    }
                },
                {
                    "type": "script",
                    "value": {
                        "id": "user-script-0",
                        "name": "变量结构设计",
                        "content": "/*\r\n * 特莱恩大陆 - 变量结构定义\r\n * 使用 Zod 4.x Schema 定义所有游戏数据结构\r\n */\r\n\r\nconst statSchema = z.object({\r\n  /* ========== 军队系统 ========== */\r\n  army: z.object({\r\n    /* 将领列表 */\r\n    commanders: z.array(z.object({\r\n      /* 将领基础信息 */\r\n      id: z.string(),                          /* 唯一标识 */\r\n      name: z.string(),                        /* 将领名称 */\r\n      title: z.string().optional(),            /* 称号（可选） */\r\n      profession: z.string(),                  /* 职业 */\r\n      level: z.coerce.number().default(1),     /* 等级 */\r\n\r\n      /* 将领属性 */\r\n      attributes: z.object({\r\n        leadership: z.coerce.number().default(10),  /* 领导力 - 影响部队士气和数量上限 */\r\n        tactics: z.coerce.number().default(10),     /* 智谋 - 影响技能效果 */\r\n        bravery: z.coerce.number().default(10),     /* 武勇 - 影响部队攻击加成 */\r\n      }),\r\n\r\n      /* 将领技能 */\r\n      skills: z.array(z.string()).default([]),\r\n\r\n      /* 部队信息 */\r\n      unit: z.object({\r\n        type: z.string(),                           /* 兵种名称 */\r\n        currentCount: z.coerce.number(),            /* 当前兵员数 */\r\n        maxCount: z.coerce.number(),                /* 最大兵员数 */\r\n        frontRowHp: z.coerce.number().optional(),   /* 最前排士兵剩余HP（用于精确伤亡计算） */\r\n      }),\r\n\r\n      /* 卡面自定义（可选） */\r\n      cardCustomization: z.object({\r\n        portrait: z.string().optional(),            /* 卡面图片URL */\r\n        frame: z.enum([\"normal\", \"elite\", \"legendary\"]).default(\"normal\"),\r\n        theme: z.string().optional(),               /* 主题色 */\r\n      }).optional(),\r\n    })),\r\n  }),\r\n\r\n  /* ========== 资源系统 ========== */\r\n  resources: z.object({\r\n    gold: z.coerce.number().default(0),             /* 金币 */\r\n    supplies: z.coerce.number().default(0),         /* 补给品（用于补兵） */\r\n  }),\r\n\r\n  /* ========== 战斗配置（由LLM设定） ========== */\r\n  battle_config: z.object({\r\n    /* 敌方将领+部队列表 */\r\n    enemies: z.array(z.object({\r\n      id: z.string(),\r\n      name: z.string(),\r\n      unit: z.object({\r\n        type: z.string(),\r\n        count: z.coerce.number(),\r\n      }),\r\n      skills: z.array(z.string()).default([]),\r\n      /* 敌方卡面（可选，匹配预设或使用默认） */\r\n      cardCustomization: z.object({\r\n        portrait: z.string().optional(),\r\n        frame: z.enum([\"normal\", \"elite\", \"legendary\"]).default(\"normal\"),\r\n      }).optional(),\r\n    })).default([]),\r\n\r\n    /* 胜利条件 */\r\n    winCondition: z.string().default(\"击败所有敌人\"),\r\n\r\n    /* 特殊规则 */\r\n    specialRules: z.string().optional(),\r\n\r\n    /* 预设对话 */\r\n    dialogues: z.array(z.object({\r\n      trigger: z.string(),                          /* 触发条件 */\r\n      speaker: z.string(),                          /* 说话者 */\r\n      text: z.string(),                             /* 对话内容 */\r\n      responder: z.string().optional(),             /* 回应者（可选） */\r\n      response: z.string().optional(),              /* 回应内容（可选） */\r\n    })).default([]),\r\n  }),\r\n\r\n  /* ========== 战斗状态 ========== */\r\n  battle_state: z.object({\r\n    inBattle: z.boolean().default(false),           /* 是否在战斗中 */\r\n    currentTurn: z.coerce.number().default(0),      /* 当前回合数 */\r\n\r\n    /* 战斗结果（战斗结束后填充） */\r\n    result: z.enum([\"none\", \"victory\", \"defeat\", \"retreat\"]).default(\"none\"),\r\n\r\n    /* 我方伤亡记录 */\r\n    ourCasualties: z.record(z.string(), z.object({\r\n      unit: z.string(),\r\n      initial: z.coerce.number(),\r\n      remaining: z.coerce.number(),\r\n      lost: z.coerce.number(),\r\n    })).default({}),\r\n\r\n    /* 敌方伤亡记录 */\r\n    enemyCasualties: z.record(z.string(), z.object({\r\n      unit: z.string(),\r\n      initial: z.coerce.number(),\r\n      remaining: z.coerce.number(),\r\n      lost: z.coerce.number(),\r\n    })).default({}),\r\n\r\n    /* 获得奖励 */\r\n    rewards: z.object({\r\n      exp: z.coerce.number().default(0),\r\n      gold: z.coerce.number().default(0),\r\n      items: z.array(z.string()).default([]),\r\n    }),\r\n  }),\r\n\r\n  /* ========== 卡面自定义配置 ========== */\r\n  card_customization: z.object({\r\n    /* 我方将领卡面 */\r\n    ally_commanders: z.record(z.string(), z.object({\r\n      portrait: z.string().optional(),\r\n      frame: z.enum([\"normal\", \"elite\", \"legendary\"]).default(\"normal\"),\r\n      theme: z.string().optional(),\r\n    })).default({}),\r\n\r\n    /* 敌方将领/兵种卡面预设 */\r\n    enemy_portraits: z.record(z.string(), z.object({\r\n      portrait: z.string().optional(),\r\n      frame: z.enum([\"normal\", \"elite\", \"legendary\"]).default(\"normal\"),\r\n    })).default({}),\r\n\r\n    /* 兵种图标 */\r\n    unit_icons: z.record(z.string(), z.string()).default({}),\r\n  }),\r\n\r\n  /* ========== 游戏进度 ========== */\r\n  progress: z.object({\r\n    chapter: z.coerce.number().default(1),          /* 当前章节 */\r\n    totalBattles: z.coerce.number().default(0),     /* 总战斗次数 */\r\n    victories: z.coerce.number().default(0),        /* 胜利次数 */\r\n  }),\r\n});\r\n",
                        "info": "",
                        "buttons": [],
                        "data": {},
                        "enabled": true
                    }
                },
                {
                    "type": "script",
                    "value": {
                        "id": "user-script-1",
                        "name": "游戏数据",
                        "content": "/*\r\n * 特莱恩大陆 - 游戏数据定义\r\n * 包含：兵种模板、技能数据、敌人模板、默认卡面素材\r\n */\r\n\r\n/* ========== 兵种模板 ========== */\r\nconst UNIT_TEMPLATES = {\r\n  /* === 我方兵种 === */\r\n  \"剑士\": {\r\n    hp: 15,\r\n    atk: 10,\r\n    def: 8,\r\n    spd: 5,\r\n    skills: [\"盾墙\"],\r\n    description: \"攻守平衡的近战步兵，擅长正面交锋\",\r\n    recruitCost: { gold: 10, supplies: 1 },\r\n  },\r\n  \"长枪兵\": {\r\n    hp: 12,\r\n    atk: 12,\r\n    def: 5,\r\n    spd: 6,\r\n    skills: [\"枪阵\"],\r\n    description: \"高攻击的步兵，对骑兵有额外伤害\",\r\n    recruitCost: { gold: 12, supplies: 1 },\r\n  },\r\n  \"弓箭手\": {\r\n    hp: 10,\r\n    atk: 14,\r\n    def: 3,\r\n    spd: 7,\r\n    skills: [\"齐射\"],\r\n    description: \"远程攻击单位，优先攻击后排\",\r\n    recruitCost: { gold: 15, supplies: 1 },\r\n  },\r\n  \"骑兵\": {\r\n    hp: 18,\r\n    atk: 12,\r\n    def: 6,\r\n    spd: 12,\r\n    skills: [\"冲锋\"],\r\n    description: \"高机动性单位，首回合攻击加成\",\r\n    recruitCost: { gold: 25, supplies: 2 },\r\n  },\r\n  \"法师\": {\r\n    hp: 8,\r\n    atk: 16,\r\n    def: 2,\r\n    spd: 4,\r\n    skills: [\"火球术\"],\r\n    description: \"魔法攻击单位，无视部分防御\",\r\n    recruitCost: { gold: 30, supplies: 2 },\r\n  },\r\n  \"牧师\": {\r\n    hp: 10,\r\n    atk: 4,\r\n    def: 4,\r\n    spd: 3,\r\n    skills: [\"治愈之光\"],\r\n    description: \"治疗单位，可恢复我方部队兵员\",\r\n    recruitCost: { gold: 28, supplies: 2 },\r\n  },\r\n\r\n  /* === 敌方兵种 === */\r\n  \"哥布林\": {\r\n    hp: 8,\r\n    atk: 6,\r\n    def: 2,\r\n    spd: 8,\r\n    skills: [\"群攻\"],\r\n    description: \"弱小但数量众多的杂兵\",\r\n  },\r\n  \"哥布林弓手\": {\r\n    hp: 6,\r\n    atk: 8,\r\n    def: 1,\r\n    spd: 7,\r\n    skills: [\"毒箭\"],\r\n    description: \"使用毒箭的哥布林远程单位\",\r\n  },\r\n  \"座狼\": {\r\n    hp: 12,\r\n    atk: 10,\r\n    def: 4,\r\n    spd: 14,\r\n    skills: [\"撕咬\"],\r\n    description: \"快速的野兽，擅长突袭\",\r\n  },\r\n  \"兽人\": {\r\n    hp: 20,\r\n    atk: 14,\r\n    def: 6,\r\n    spd: 5,\r\n    skills: [\"狂暴\"],\r\n    description: \"强壮的兽人战士\",\r\n  },\r\n  \"骷髅兵\": {\r\n    hp: 10,\r\n    atk: 8,\r\n    def: 4,\r\n    spd: 4,\r\n    skills: [\"不死\"],\r\n    description: \"亡灵士兵，免疫毒素和流血\",\r\n  },\r\n  \"暗影刺客\": {\r\n    hp: 10,\r\n    atk: 18,\r\n    def: 2,\r\n    spd: 15,\r\n    skills: [\"暗杀\"],\r\n    description: \"高伤害的刺客，优先攻击低HP目标\",\r\n  },\r\n};\r\n\r\n/* ========== 技能数据 ========== */\r\nconst SKILL_TEMPLATES = {\r\n  /* === 部队技能 === */\r\n  \"盾墙\": {\r\n    type: \"unit\",\r\n    category: \"defense\",\r\n    description: \"本回合防御+50%\",\r\n    effect: { defBonus: 0.5, duration: 1 },\r\n    cooldown: 2,\r\n  },\r\n  \"枪阵\": {\r\n    type: \"unit\",\r\n    category: \"passive\",\r\n    description: \"对骑兵类单位伤害+50%\",\r\n    effect: { damageBonus: 0.5, targetType: \"cavalry\" },\r\n  },\r\n  \"齐射\": {\r\n    type: \"unit\",\r\n    category: \"attack\",\r\n    description: \"对所有敌人造成50%攻击力的伤害\",\r\n    effect: { damageMultiplier: 0.5, aoe: true },\r\n    cooldown: 3,\r\n  },\r\n  \"冲锋\": {\r\n    type: \"unit\",\r\n    category: \"passive\",\r\n    description: \"战斗首回合攻击+30%\",\r\n    effect: { atkBonus: 0.3, condition: \"firstTurn\" },\r\n  },\r\n  \"火球术\": {\r\n    type: \"unit\",\r\n    category: \"attack\",\r\n    description: \"造成120%魔法伤害，无视30%防御\",\r\n    effect: { damageMultiplier: 1.2, ignoreDefense: 0.3 },\r\n    cooldown: 2,\r\n  },\r\n  \"治愈之光\": {\r\n    type: \"unit\",\r\n    category: \"heal\",\r\n    description: \"恢复目标部队20%最大兵员\",\r\n    effect: { healPercent: 0.2 },\r\n    cooldown: 3,\r\n  },\r\n  \"群攻\": {\r\n    type: \"unit\",\r\n    category: \"passive\",\r\n    description: \"数量越多攻击越高（每10人+5%攻击）\",\r\n    effect: { atkBonusPerUnit: 0.005, perUnitCount: 10 },\r\n  },\r\n  \"毒箭\": {\r\n    type: \"unit\",\r\n    category: \"debuff\",\r\n    description: \"使目标中毒，每回合损失5%兵员，持续2回合\",\r\n    effect: { dot: 0.05, duration: 2 },\r\n    cooldown: 3,\r\n  },\r\n  \"撕咬\": {\r\n    type: \"unit\",\r\n    category: \"attack\",\r\n    description: \"造成130%伤害\",\r\n    effect: { damageMultiplier: 1.3 },\r\n    cooldown: 2,\r\n  },\r\n  \"狂暴\": {\r\n    type: \"unit\",\r\n    category: \"buff\",\r\n    description: \"攻击+50%，防御-30%，持续2回合\",\r\n    effect: { atkBonus: 0.5, defPenalty: -0.3, duration: 2 },\r\n    cooldown: 4,\r\n  },\r\n  \"不死\": {\r\n    type: \"unit\",\r\n    category: \"passive\",\r\n    description: \"免疫毒素和流血效果\",\r\n    effect: { immunities: [\"poison\", \"bleed\"] },\r\n  },\r\n  \"暗杀\": {\r\n    type: \"unit\",\r\n    category: \"attack\",\r\n    description: \"对HP低于30%的目标造成200%伤害\",\r\n    effect: { damageMultiplier: 2.0, condition: \"targetHpBelow30\" },\r\n    cooldown: 3,\r\n  },\r\n\r\n  /* === 将领技能 === */\r\n  \"鼓舞\": {\r\n    type: \"commander\",\r\n    category: \"buff\",\r\n    description: \"我方全体攻击+20%，持续2回合\",\r\n    effect: { atkBonus: 0.2, duration: 2, target: \"allAllies\" },\r\n    cooldown: 4,\r\n  },\r\n  \"冲锋指令\": {\r\n    type: \"commander\",\r\n    category: \"buff\",\r\n    description: \"指定部队本回合速度+100%，优先行动\",\r\n    effect: { spdBonus: 1.0, duration: 1, target: \"single\" },\r\n    cooldown: 3,\r\n  },\r\n  \"战术撤退\": {\r\n    type: \"commander\",\r\n    category: \"utility\",\r\n    description: \"指定部队退出战斗，保留剩余兵员\",\r\n    effect: { retreatUnit: true, target: \"single\" },\r\n    cooldown: 5,\r\n  },\r\n  \"集中火力\": {\r\n    type: \"commander\",\r\n    category: \"buff\",\r\n    description: \"指定敌方目标，我方全体对其伤害+30%，持续2回合\",\r\n    effect: { markTarget: true, damageBonus: 0.3, duration: 2 },\r\n    cooldown: 4,\r\n  },\r\n  \"治疗术\": {\r\n    type: \"commander\",\r\n    category: \"heal\",\r\n    description: \"恢复指定部队30%兵员\",\r\n    effect: { healPercent: 0.3, target: \"single\" },\r\n    cooldown: 4,\r\n  },\r\n  \"火焰风暴\": {\r\n    type: \"commander\",\r\n    category: \"attack\",\r\n    description: \"对所有敌人造成将领智谋×2的伤害\",\r\n    effect: { damageFormula: \"tactics * 2\", aoe: true },\r\n    cooldown: 5,\r\n  },\r\n};\r\n\r\n/* ========== 敌方将领模板 ========== */\r\nconst ENEMY_COMMANDER_TEMPLATES = {\r\n  \"哥布林头目\": {\r\n    attributes: { leadership: 5, tactics: 2, bravery: 3 },\r\n    skills: [\"鼓舞\"],\r\n    defaultUnit: \"哥布林\",\r\n    description: \"统领哥布林的小头目\",\r\n  },\r\n  \"狼骑士\": {\r\n    attributes: { leadership: 8, tactics: 5, bravery: 7 },\r\n    skills: [\"冲锋指令\"],\r\n    defaultUnit: \"座狼\",\r\n    description: \"骑乘座狼的精锐骑兵\",\r\n  },\r\n  \"兽人队长\": {\r\n    attributes: { leadership: 10, tactics: 4, bravery: 12 },\r\n    skills: [\"鼓舞\", \"集中火力\"],\r\n    defaultUnit: \"兽人\",\r\n    description: \"兽人部落的战斗队长\",\r\n  },\r\n  \"亡灵法师\": {\r\n    attributes: { leadership: 6, tactics: 15, bravery: 2 },\r\n    skills: [\"火焰风暴\"],\r\n    defaultUnit: \"骷髅兵\",\r\n    description: \"操纵亡灵的黑暗法师\",\r\n  },\r\n  \"暗影领主\": {\r\n    attributes: { leadership: 12, tactics: 10, bravery: 8 },\r\n    skills: [\"集中火力\", \"战术撤退\"],\r\n    defaultUnit: \"暗影刺客\",\r\n    description: \"神秘的暗影组织首领\",\r\n  },\r\n};\r\n\r\n/* ========== 默认卡面素材 ========== */\r\nconst DEFAULT_CARD_ASSETS = {\r\n  /* 卡框样式 */\r\n  frames: {\r\n    normal: {\r\n      borderColor: \"#8B7355\",\r\n      glowColor: \"rgba(139, 115, 85, 0.5)\",\r\n    },\r\n    elite: {\r\n      borderColor: \"#4169E1\",\r\n      glowColor: \"rgba(65, 105, 225, 0.6)\",\r\n    },\r\n    legendary: {\r\n      borderColor: \"#FFD700\",\r\n      glowColor: \"rgba(255, 215, 0, 0.7)\",\r\n    },\r\n  },\r\n\r\n  /* 默认兵种图标（使用emoji作为占位符，实际可替换为URL） */\r\n  unitIcons: {\r\n    \"剑士\": \"https://placehold.co/80x80/4a5568/ffffff?text=剑\",\r\n    \"长枪兵\": \"https://placehold.co/80x80/4a5568/ffffff?text=枪\",\r\n    \"弓箭手\": \"https://placehold.co/80x80/4a5568/ffffff?text=弓\",\r\n    \"骑兵\": \"https://placehold.co/80x80/4a5568/ffffff?text=骑\",\r\n    \"法师\": \"https://placehold.co/80x80/4a5568/ffffff?text=法\",\r\n    \"牧师\": \"https://placehold.co/80x80/4a5568/ffffff?text=牧\",\r\n    \"哥布林\": \"https://placehold.co/80x80/2d5a27/ffffff?text=哥\",\r\n    \"哥布林弓手\": \"https://placehold.co/80x80/2d5a27/ffffff?text=弓\",\r\n    \"座狼\": \"https://placehold.co/80x80/5a4a3a/ffffff?text=狼\",\r\n    \"兽人\": \"https://placehold.co/80x80/5a3a2a/ffffff?text=兽\",\r\n    \"骷髅兵\": \"https://placehold.co/80x80/3a3a3a/ffffff?text=骷\",\r\n    \"暗影刺客\": \"https://placehold.co/80x80/1a1a2a/ffffff?text=影\",\r\n  },\r\n\r\n  /* 默认敌方将领头像 */\r\n  enemyPortraits: {\r\n    \"哥布林头目\": \"https://placehold.co/100x100/2d5a27/ffffff?text=头目\",\r\n    \"狼骑士\": \"https://placehold.co/100x100/5a4a3a/ffffff?text=狼骑\",\r\n    \"兽人队长\": \"https://placehold.co/100x100/5a3a2a/ffffff?text=兽人\",\r\n    \"亡灵法师\": \"https://placehold.co/100x100/3a3a3a/ffffff?text=亡灵\",\r\n    \"暗影领主\": \"https://placehold.co/100x100/1a1a2a/ffffff?text=暗影\",\r\n  },\r\n};\r\n\r\n/* ========== 战斗公式常量 ========== */\r\nconst BATTLE_CONSTANTS = {\r\n  /* 伤害计算 */\r\n  DEFENSE_FACTOR: 100,           /* 防御公式中的常数：damage = atk * (1 - def/(def+DEFENSE_FACTOR)) */\r\n  DAMAGE_RANDOM_MIN: 0.9,        /* 伤害随机下限 */\r\n  DAMAGE_RANDOM_MAX: 1.1,        /* 伤害随机上限 */\r\n\r\n  /* 将领加成 */\r\n  BRAVERY_ATK_BONUS: 0.02,       /* 每点武勇增加2%攻击 */\r\n  TACTICS_SKILL_BONUS: 0.03,     /* 每点智谋增加3%技能效果 */\r\n  LEADERSHIP_COUNT_BONUS: 2,     /* 每点领导力增加2个兵员上限 */\r\n\r\n  /* 经验和奖励 */\r\n  BASE_EXP_PER_ENEMY: 10,        /* 每击杀一个敌人的基础经验 */\r\n  BASE_GOLD_PER_ENEMY: 5,        /* 每击杀一个敌人的基础金币 */\r\n};\r\n\r\n/* ========== 导出（供战斗系统使用） ========== */\r\n/*\r\n * 在HTML状态栏中，这些数据会被内联使用\r\n * 以下注释标记用于构建工具识别\r\n */\r\n/* EXPORT: UNIT_TEMPLATES */\r\n/* EXPORT: SKILL_TEMPLATES */\r\n/* EXPORT: ENEMY_COMMANDER_TEMPLATES */\r\n/* EXPORT: DEFAULT_CARD_ASSETS */\r\n/* EXPORT: BATTLE_CONSTANTS */\r\n",
                        "info": "",
                        "buttons": [],
                        "data": {},
                        "enabled": true
                    }
                }
            ]
        },
        "group_only_greetings": [],
        "character_book": {
            "entries": [
                {
                    "keys": [],
                    "secondary_keys": [],
                    "constant": false,
                    "selective": true,
                    "use_regex": true,
                    "extensions": {
                        "exclude_recursion": false,
                        "probability": 100,
                        "useProbability": true,
                        "selectiveLogic": 0,
                        "group": "",
                        "group_override": false,
                        "group_weight": 100,
                        "prevent_recursion": false,
                        "delay_until_recursion": false,
                        "scan_depth": null,
                        "match_whole_words": null,
                        "use_group_scoring": false,
                        "case_sensitive": null,
                        "automation_id": "",
                        "vectorized": false,
                        "sticky": 0,
                        "cooldown": 0,
                        "delay": 0,
                        "match_persona_description": false,
                        "match_character_description": false,
                        "match_character_personality": false,
                        "match_character_depth_prompt": false,
                        "match_scenario": false,
                        "match_creator_notes": false,
                        "triggers": [],
                        "ignore_budget": false,
                        "position": 0,
                        "display_index": 0,
                        "depth": 4,
                        "role": 0
                    },
                    "id": 0,
                    "comment": "[initvar]变量初始化",
                    "content": "<stat_data>\r\narmy:\r\n  commanders:\r\n    - id: \"commander_player\"\r\n      name: \"{{user}}\"\r\n      title: \"年轻的指挥官\"\r\n      profession: \"骑士\"\r\n      level: 1\r\n      attributes:\r\n        leadership: 12\r\n        tactics: 8\r\n        bravery: 10\r\n      skills:\r\n        - \"鼓舞\"\r\n      unit:\r\n        type: \"剑士\"\r\n        currentCount: 20\r\n        maxCount: 24\r\n        frontRowHp: 15\r\n      cardCustomization:\r\n        frame: \"elite\"\r\n\r\nresources:\r\n  gold: 100\r\n  supplies: 10\r\n\r\nbattle_config:\r\n  enemies: []\r\n  winCondition: \"击败所有敌人\"\r\n  specialRules: \"\"\r\n  dialogues: []\r\n\r\nbattle_state:\r\n  inBattle: false\r\n  currentTurn: 0\r\n  result: \"none\"\r\n  ourCasualties: {}\r\n  enemyCasualties: {}\r\n  rewards:\r\n    exp: 0\r\n    gold: 0\r\n    items: []\r\n\r\ncard_customization:\r\n  ally_commanders: {}\r\n  enemy_portraits:\r\n    \"哥布林头目\":\r\n      portrait: \"https://placehold.co/100x100/2d5a27/ffffff?text=头目\"\r\n      frame: \"normal\"\r\n    \"狼骑士\":\r\n      portrait: \"https://placehold.co/100x100/5a4a3a/ffffff?text=狼骑\"\r\n      frame: \"elite\"\r\n    \"兽人队长\":\r\n      portrait: \"https://placehold.co/100x100/5a3a2a/ffffff?text=兽人\"\r\n      frame: \"elite\"\r\n    \"亡灵法师\":\r\n      portrait: \"https://placehold.co/100x100/3a3a3a/ffffff?text=亡灵\"\r\n      frame: \"legendary\"\r\n    \"暗影领主\":\r\n      portrait: \"https://placehold.co/100x100/1a1a2a/ffffff?text=暗影\"\r\n      frame: \"legendary\"\r\n  unit_icons:\r\n    \"剑士\": \"https://placehold.co/80x80/4a5568/ffffff?text=剑\"\r\n    \"长枪兵\": \"https://placehold.co/80x80/4a5568/ffffff?text=枪\"\r\n    \"弓箭手\": \"https://placehold.co/80x80/4a5568/ffffff?text=弓\"\r\n    \"骑兵\": \"https://placehold.co/80x80/4a5568/ffffff?text=骑\"\r\n    \"法师\": \"https://placehold.co/80x80/4a5568/ffffff?text=法\"\r\n    \"牧师\": \"https://placehold.co/80x80/4a5568/ffffff?text=牧\"\r\n    \"哥布林\": \"https://placehold.co/80x80/2d5a27/ffffff?text=哥\"\r\n    \"哥布林弓手\": \"https://placehold.co/80x80/2d5a27/ffffff?text=弓\"\r\n    \"座狼\": \"https://placehold.co/80x80/5a4a3a/ffffff?text=狼\"\r\n    \"兽人\": \"https://placehold.co/80x80/5a3a2a/ffffff?text=兽\"\r\n    \"骷髅兵\": \"https://placehold.co/80x80/3a3a3a/ffffff?text=骷\"\r\n    \"暗影刺客\": \"https://placehold.co/80x80/1a1a2a/ffffff?text=影\"\r\n\r\nprogress:\r\n  chapter: 1\r\n  totalBattles: 0\r\n  victories: 0\r\n</stat_data>\r\n",
                    "enabled": false,
                    "position": "before_char",
                    "insertion_order": 101
                },
                {
                    "keys": [],
                    "secondary_keys": [],
                    "constant": true,
                    "selective": true,
                    "use_regex": true,
                    "extensions": {
                        "exclude_recursion": false,
                        "probability": 100,
                        "useProbability": true,
                        "selectiveLogic": 0,
                        "group": "",
                        "group_override": false,
                        "group_weight": 100,
                        "prevent_recursion": false,
                        "delay_until_recursion": false,
                        "scan_depth": null,
                        "match_whole_words": null,
                        "use_group_scoring": false,
                        "case_sensitive": null,
                        "automation_id": "",
                        "vectorized": false,
                        "sticky": 0,
                        "cooldown": 0,
                        "delay": 0,
                        "match_persona_description": false,
                        "match_character_description": false,
                        "match_character_personality": false,
                        "match_character_depth_prompt": false,
                        "match_scenario": false,
                        "match_creator_notes": false,
                        "triggers": [],
                        "ignore_budget": false,
                        "position": 4,
                        "display_index": 1,
                        "depth": 1,
                        "role": 0
                    },
                    "id": 1,
                    "comment": "[mvu_update]变量更新规则",
                    "content": "<update_rules>\r\n# 特莱恩大陆 - 变量更新规则\r\n# 定义非战斗时AI如何更新变量\r\n\r\n## 更新触发条件\r\n\r\n### 资源变化\r\nresources.gold:\r\n  type: number\r\n  range: 0~999999\r\n  check:\r\n    - 完成任务、战斗胜利、出售物品时增加\r\n    - 招募士兵、购买物品时减少\r\n    - 单次变化需合理说明原因\r\n\r\nresources.supplies:\r\n  type: number\r\n  range: 0~999\r\n  check:\r\n    - 获取补给、完成任务时增加\r\n    - 补充士兵时消耗\r\n    - 每补充1个士兵消耗1点补给\r\n\r\n### 军队变化\r\narmy.commanders:\r\n  check:\r\n    - 招募新将领时添加新条目\r\n    - 将领阵亡/离队时移除条目\r\n    - 不要随意修改已有将领的基础属性\r\n\r\narmy.commanders[].unit.currentCount:\r\n  type: number\r\n  range: 0~maxCount\r\n  check:\r\n    - 战斗后根据战斗结果更新（由战斗系统自动处理）\r\n    - 补兵时增加（需消耗资源）\r\n    - 特殊剧情事件可能影响\r\n\r\narmy.commanders[].level:\r\n  type: number\r\n  range: 1~99\r\n  check:\r\n    - 累积足够经验后升级\r\n    - 升级时可适当提升属性\r\n\r\n### 游戏进度\r\nprogress.chapter:\r\n  type: number\r\n  check:\r\n    - 完成章节主线任务后递增\r\n    - 不要随意跳跃章节\r\n\r\nprogress.totalBattles:\r\n  type: number\r\n  check:\r\n    - 每次战斗结束后+1（无论胜负）\r\n\r\nprogress.victories:\r\n  type: number\r\n  check:\r\n    - 战斗胜利后+1\r\n\r\n## 更新格式\r\n# AI需要使用JSON Patch格式更新变量\r\n# 示例:\r\n# [\r\n#   { \"op\": \"replace\", \"path\": \"/resources/gold\", \"value\": 150 },\r\n#   { \"op\": \"replace\", \"path\": \"/army/commanders/0/unit/currentCount\", \"value\": 25 }\r\n# ]\r\n</update_rules>\r\n",
                    "enabled": true,
                    "position": "at_depth",
                    "insertion_order": 1
                },
                {
                    "keys": [],
                    "secondary_keys": [],
                    "constant": true,
                    "selective": true,
                    "use_regex": true,
                    "extensions": {
                        "exclude_recursion": false,
                        "probability": 100,
                        "useProbability": true,
                        "selectiveLogic": 0,
                        "group": "",
                        "group_override": false,
                        "group_weight": 100,
                        "prevent_recursion": false,
                        "delay_until_recursion": false,
                        "scan_depth": null,
                        "match_whole_words": null,
                        "use_group_scoring": false,
                        "case_sensitive": null,
                        "automation_id": "",
                        "vectorized": false,
                        "sticky": 0,
                        "cooldown": 0,
                        "delay": 0,
                        "match_persona_description": false,
                        "match_character_description": false,
                        "match_character_personality": false,
                        "match_character_depth_prompt": false,
                        "match_scenario": false,
                        "match_creator_notes": false,
                        "triggers": [],
                        "ignore_budget": false,
                        "position": 4,
                        "display_index": 2,
                        "depth": 1,
                        "role": 0
                    },
                    "id": 2,
                    "comment": "[mvu_update]变量输出格式",
                    "content": "<output_format>\r\n# 特莱恩大陆 - 变量输出规则\r\n# 定义AI如何在回复中输出变量更新\r\n\r\n## 输出时机\r\n- 当需要更新游戏状态时（资源变化、军队变化、进度变化等）\r\n- 战斗配置设定时\r\n- 招募新将领/部队时\r\n\r\n## 输出格式\r\n\r\n### 资源更新\r\n当资源发生变化时，使用以下格式：\r\n```\r\n[变量更新]\r\nresources.gold: {新值}\r\nresources.supplies: {新值}\r\n[/变量更新]\r\n```\r\n\r\n### 军队更新\r\n招募新将领时：\r\n```\r\n[变量更新]\r\narmy.commanders[+]:\r\n  id: \"{唯一ID}\"\r\n  name: \"{将领名}\"\r\n  title: \"{称号}\"\r\n  profession: \"{职业}\"\r\n  level: 1\r\n  attributes:\r\n    leadership: {数值}\r\n    tactics: {数值}\r\n    bravery: {数值}\r\n  skills:\r\n    - \"{技能名}\"\r\n  unit:\r\n    type: \"{兵种名}\"\r\n    currentCount: {数量}\r\n    maxCount: {最大数量}\r\n[/变量更新]\r\n```\r\n\r\n补充兵员时：\r\n```\r\n[变量更新]\r\narmy.commanders[{索引}].unit.currentCount: {新数量}\r\nresources.gold: {扣除后金币}\r\nresources.supplies: {扣除后补给}\r\n[/变量更新]\r\n```\r\n\r\n### 战斗配置\r\n进入战斗前，必须设定战斗配置：\r\n```\r\n[战斗配置]\r\n敌方:\r\n  - 将领: {敌方将领名}\r\n    部队: {兵种名}\r\n    数量: {数量}\r\n    技能:\r\n      - {技能名}\r\n  - 将领: {敌方将领名2}\r\n    部队: {兵种名}\r\n    数量: {数量}\r\n\r\n胜利条件: {描述胜利条件}\r\n特殊规则: {可选，特殊战斗规则}\r\n\r\n预设对话:\r\n  - 触发: 战斗开始\r\n    说话者: {角色名}\r\n    对话: \"{对话内容}\"\r\n\r\n  - 触发: {角色A} 攻击 {角色B}\r\n    说话者: {角色A}\r\n    对话: \"{对话内容}\"\r\n    回应者: {角色B}\r\n    回应: \"{回应内容}\"\r\n\r\n  - 触发: {角色A} 击败 {角色B}\r\n    说话者: {角色A}\r\n    对话: \"{对话内容}\"\r\n\r\n  - 触发: 我方HP低于{百分比}%\r\n    说话者: {角色名}\r\n    对话: \"{对话内容}\"\r\n\r\n  - 触发: 回合{数字}\r\n    说话者: {角色名}\r\n    对话: \"{对话内容}\"\r\n\r\n  - 触发: 胜利\r\n    说话者: {角色名}\r\n    对话: \"{对话内容}\"\r\n\r\n  - 触发: 失败\r\n    说话者: {角色名}\r\n    对话: \"{对话内容}\"\r\n[/战斗配置]\r\n[开始战斗]\r\n```\r\n\r\n### 进度更新\r\n章节推进时：\r\n```\r\n[变量更新]\r\nprogress.chapter: {新章节数}\r\n[/变量更新]\r\n```\r\n\r\n## 注意事项\r\n1. 变量更新应该在叙事文本之后输出\r\n2. 战斗配置必须在[开始战斗]标记之前完成\r\n3. 预设对话应该根据参战角色的关系和剧情背景设计\r\n4. 敌方将领名如果匹配预设模板（如\"哥布林头目\"），会自动使用模板数据\r\n5. 战斗结束后，系统会自动发送战斗结果作为用户消息\r\n</output_format>\r\n",
                    "enabled": true,
                    "position": "at_depth",
                    "insertion_order": 2
                },
                {
                    "keys": [],
                    "secondary_keys": [],
                    "constant": true,
                    "selective": true,
                    "use_regex": true,
                    "extensions": {
                        "exclude_recursion": false,
                        "probability": 100,
                        "useProbability": true,
                        "selectiveLogic": 0,
                        "group": "",
                        "group_override": false,
                        "group_weight": 100,
                        "prevent_recursion": false,
                        "delay_until_recursion": false,
                        "scan_depth": null,
                        "match_whole_words": null,
                        "use_group_scoring": false,
                        "case_sensitive": null,
                        "automation_id": "",
                        "vectorized": false,
                        "sticky": 0,
                        "cooldown": 0,
                        "delay": 0,
                        "match_persona_description": false,
                        "match_character_description": false,
                        "match_character_personality": false,
                        "match_character_depth_prompt": false,
                        "match_scenario": false,
                        "match_creator_notes": false,
                        "triggers": [],
                        "ignore_budget": false,
                        "position": 0,
                        "display_index": 3,
                        "depth": 4,
                        "role": 0
                    },
                    "id": 3,
                    "comment": "背景设定",
                    "content": "<world_background>\r\n# 特莱恩大陆 - 世界观设定\r\n\r\n## 世界概述\r\n\r\n特莱恩大陆是一片充满魔法与冒险的广袤土地。这里曾经是诸神的乐园，如今则是人类、精灵、矮人等种族共同生活的家园。大陆上遍布着古老的遗迹、神秘的森林和危险的地下城，无数冒险者在这里追寻着财富与荣耀。\r\n\r\n## 地理区域\r\n\r\n### 中央王国 - 艾尔德里亚\r\n大陆中央的人类王国，以骑士精神和魔法学院闻名。首都\"银冠城\"是大陆最繁华的城市。\r\n\r\n### 北方领地 - 冰霜边境\r\n严寒的北方土地，居住着坚韧的北方部落。这里是优秀战士的摇篮，也是抵御魔物入侵的第一道防线。\r\n\r\n### 东方森林 - 翠叶密林\r\n精灵族的故乡，古老的森林中隐藏着无数秘密。精灵们与自然和谐共处，擅长弓术和自然魔法。\r\n\r\n### 西方山脉 - 铁砧山脉\r\n矮人王国的所在地，巨大的地下城市中回荡着锻造的声音。矮人工匠的武器和盔甲是大陆上最受追捧的商品。\r\n\r\n### 南方荒野 - 灼热平原\r\n干燥炎热的南方土地，游牧部落和商人队伍穿梭其间。这里也是许多魔物的栖息地。\r\n\r\n## 主要种族\r\n\r\n### 人类\r\n适应力强、野心勃勃的种族。建立了大陆上最大的王国，在政治和商业上占据主导地位。\r\n\r\n### 精灵\r\n长寿而优雅的种族，与自然有着深厚的联系。擅长弓术、魔法和艺术。\r\n\r\n### 矮人\r\n坚韧而勤劳的种族，是天生的工匠和战士。虽然身材矮小，但战斗力不容小觑。\r\n\r\n### 兽人\r\n生活在荒野的强壮种族，以部落为单位。虽然常被视为威胁，但也有友善的兽人部落。\r\n\r\n## 魔法体系\r\n\r\n特莱恩大陆的魔法源自\"以太之流\"——一种遍布世界的神秘能量。\r\n\r\n### 元素魔法\r\n控制火、水、风、土四大元素的魔法，是最常见的魔法类型。\r\n\r\n### 神圣魔法\r\n源自对神灵信仰的力量，主要用于治疗和驱邪。\r\n\r\n### 暗黑魔法\r\n操纵死亡和阴影的禁忌魔法，使用者常被视为异端。\r\n\r\n### 符文魔法\r\n矮人发展出的独特魔法体系，通过在物品上刻画符文来附加魔法效果。\r\n\r\n## 军事体系\r\n\r\n### 骑士团\r\n艾尔德里亚王国的精锐力量，由贵族子弟组成。装备精良，纪律严明。\r\n\r\n### 佣兵团\r\n遍布大陆的雇佣军队，为金币而战。实力参差不齐，但其中不乏精锐。\r\n\r\n### 民兵队\r\n各地城镇的自卫力量，通常由退役士兵和普通市民组成。\r\n\r\n### 魔物军团\r\n由暗黑势力控制的魔物大军，是和平的最大威胁。\r\n\r\n## 当前局势\r\n\r\n近年来，沉寂已久的暗黑势力开始蠢蠢欲动。边境地区魔物袭击频发，各国开始加强军备。与此同时，一个神秘的预言在民间流传——\"当银月染血之时，来自异世界的英雄将改变大陆的命运。\"\r\n\r\n玩家作为一名新晋的年轻指挥官，将在这个风起云涌的时代书写自己的传奇。\r\n</world_background>\r\n",
                    "enabled": true,
                    "position": "before_char",
                    "insertion_order": 1
                },
                {
                    "keys": [],
                    "secondary_keys": [],
                    "constant": true,
                    "selective": true,
                    "use_regex": true,
                    "extensions": {
                        "exclude_recursion": false,
                        "probability": 100,
                        "useProbability": true,
                        "selectiveLogic": 0,
                        "group": "",
                        "group_override": false,
                        "group_weight": 100,
                        "prevent_recursion": false,
                        "delay_until_recursion": false,
                        "scan_depth": null,
                        "match_whole_words": null,
                        "use_group_scoring": false,
                        "case_sensitive": null,
                        "automation_id": "",
                        "vectorized": false,
                        "sticky": 0,
                        "cooldown": 0,
                        "delay": 0,
                        "match_persona_description": false,
                        "match_character_description": false,
                        "match_character_personality": false,
                        "match_character_depth_prompt": false,
                        "match_scenario": false,
                        "match_creator_notes": false,
                        "triggers": [],
                        "ignore_budget": false,
                        "position": 0,
                        "display_index": 4,
                        "depth": 4,
                        "role": 0
                    },
                    "id": 4,
                    "comment": "玩家角色_{{user}}",
                    "content": "<player_character>\r\n# {{user}} - 玩家角色设定\r\n\r\n## 基础信息\r\n\r\n{{user}}是一名来自现代世界的年轻人，在一次意外中穿越到了特莱恩大陆。\r\n幸运的是，穿越时获得了一些基础的战斗知识和领导才能。\r\n\r\n## 初始身份\r\n\r\n- **称号**: 年轻的指挥官\r\n- **职业**: 骑士（初始）\r\n- **等级**: 1\r\n\r\n## 初始属性\r\n\r\n- **领导力**: 12 - 影响部队士气和最大兵员数\r\n- **智谋**: 8 - 影响技能效果和战术判断\r\n- **武勇**: 10 - 影响部队攻击加成\r\n\r\n## 初始技能\r\n\r\n- **鼓舞**: 我方全体攻击+20%，持续2回合\r\n\r\n## 初始部队\r\n\r\n- **兵种**: 剑士\r\n- **当前数量**: 20人\r\n- **最大数量**: 24人\r\n\r\n## 性格特点\r\n\r\n{{user}}保持着现代人的思维方式，对这个奇幻世界充满好奇。\r\n虽然面对危险时会紧张，但内心深处有着不屈的勇气。\r\n重视同伴，相信团结的力量。\r\n\r\n## 成长潜力\r\n\r\n作为穿越者，{{user}}拥有独特的成长潜力：\r\n- 可以学习各种职业的技能\r\n- 能够理解和分析敌人的战术\r\n- 拥有现代的战略思维\r\n\r\n## 玩家扮演指南\r\n\r\n玩家可以自由决定{{user}}的：\r\n- 对话风格和性格表现\r\n- 战斗中的决策和战术选择\r\n- 与NPC的关系发展\r\n- 故事中的道德抉择\r\n\r\nAI会根据玩家的选择调整剧情发展，战斗系统则提供公平的挑战。\r\n</player_character>\r\n",
                    "enabled": true,
                    "position": "before_char",
                    "insertion_order": 2
                }
            ],
            "name": "特莱恩大陆"
        }
    },
    "create_date": "2026-1-12 @22h 31m 30s 49ms"
}